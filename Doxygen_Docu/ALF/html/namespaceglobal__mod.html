<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ALF: global_mod Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ALF
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions/Subroutines</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">global_mod Module Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Handles global updates and parallel tempering.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a090aa1cf2445e51b1315808df6eb028c"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceglobal__mod.html#a090aa1cf2445e51b1315808df6eb028c">exchange_step</a> (Phase, GR, udvr, udvl, Stab_nt, udvst, N_exchange_steps, Tempering_calc_det)</td></tr>
<tr class="memdesc:a090aa1cf2445e51b1315808df6eb028c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Handles parrallel tempering This subroutine is called only if the tempering flag is switched on.  <a href="#a090aa1cf2445e51b1315808df6eb028c">More...</a><br /></td></tr>
<tr class="separator:a090aa1cf2445e51b1315808df6eb028c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4a02e45603e49769d5d2757c82508331"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceglobal__mod.html#a4a02e45603e49769d5d2757c82508331">global_updates</a> (Phase, GR, udvr, udvl, Stab_nt, udvst, N_Global)</td></tr>
<tr class="memdesc:a4a02e45603e49769d5d2757c82508331"><td class="mdescLeft">&#160;</td><td class="mdescRight">Carries out N_global global updates as defeined in the Global_move routine of the Hamiltonian module.  <a href="#a4a02e45603e49769d5d2757c82508331">More...</a><br /></td></tr>
<tr class="separator:a4a02e45603e49769d5d2757c82508331"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab177641a883cf4886d53bf0ec95b3247"><td class="memItemLeft" align="right" valign="top">complex(kind=kind(0.d0)) function&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceglobal__mod.html#ab177641a883cf4886d53bf0ec95b3247">compute_ratio_global</a> (Phase_Det_old, Phase_Det_new, Det_vec_old, Det_vec_new, nsigma_old, T0_Proposal_ratio, Ratio)</td></tr>
<tr class="memdesc:ab177641a883cf4886d53bf0ec95b3247"><td class="mdescLeft">&#160;</td><td class="mdescRight">This fucntion computes ratio of weights for global moves.  <a href="#ab177641a883cf4886d53bf0ec95b3247">More...</a><br /></td></tr>
<tr class="separator:ab177641a883cf4886d53bf0ec95b3247"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4007b571e683c0ec913901b519352aad"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceglobal__mod.html#a4007b571e683c0ec913901b519352aad">compute_fermion_det</a> (Phase_det, Det_Vec, udvl, udvst, Stab_nt, storage)</td></tr>
<tr class="memdesc:a4007b571e683c0ec913901b519352aad"><td class="mdescLeft">&#160;</td><td class="mdescRight">Computes the fermion determinant from scratch or from the storage.  <a href="#a4007b571e683c0ec913901b519352aad">More...</a><br /></td></tr>
<tr class="separator:a4007b571e683c0ec913901b519352aad"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acc8784f6dafc9c0259291e16b16ed6d4"><td class="memItemLeft" align="right" valign="top">integer function&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceglobal__mod.html#acc8784f6dafc9c0259291e16b16ed6d4">npbc_tempering</a> (n, Isize)</td></tr>
<tr class="memdesc:acc8784f6dafc9c0259291e16b16ed6d4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Periodic boundary conditions required to defined master and slave for the <br />
<br />
 tempering.  <a href="#acc8784f6dafc9c0259291e16b16ed6d4">More...</a><br /></td></tr>
<tr class="separator:acc8784f6dafc9c0259291e16b16ed6d4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a349bf6537abbd7eac41cade766f37574"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceglobal__mod.html#a349bf6537abbd7eac41cade766f37574">global_tempering_setup</a></td></tr>
<tr class="memdesc:a349bf6537abbd7eac41cade766f37574"><td class="mdescLeft">&#160;</td><td class="mdescRight">The following routine monitors the acceptance of tempering moves.  <a href="#a349bf6537abbd7eac41cade766f37574">More...</a><br /></td></tr>
<tr class="separator:a349bf6537abbd7eac41cade766f37574"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae7afd49ef8db9c25c56cb64e18987b64"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceglobal__mod.html#ae7afd49ef8db9c25c56cb64e18987b64">global_tempering_init_obs</a></td></tr>
<tr class="separator:ae7afd49ef8db9c25c56cb64e18987b64"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a65a05c74b02004eb46aa33f9c8464601"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceglobal__mod.html#a65a05c74b02004eb46aa33f9c8464601">global_tempering_obser</a> (toggle)</td></tr>
<tr class="separator:a65a05c74b02004eb46aa33f9c8464601"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abc55ba04905320858e15ecc7e9d20de4"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceglobal__mod.html#abc55ba04905320858e15ecc7e9d20de4">global_tempering_pr</a></td></tr>
<tr class="separator:abc55ba04905320858e15ecc7e9d20de4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a5fffa8bf277527c37a705dd5d13e04c3"><td class="memItemLeft" align="right" valign="top">type(obser_vec), private&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceglobal__mod.html#a5fffa8bf277527c37a705dd5d13e04c3">tempering_acceptance</a></td></tr>
<tr class="separator:a5fffa8bf277527c37a705dd5d13e04c3"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Handles global updates and parallel tempering. </p>
<dl class="section author"><dt>Author</dt><dd>ALF-project </dd></dl>
</div><h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a4007b571e683c0ec913901b519352aad"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4007b571e683c0ec913901b519352aad">&#9670;&nbsp;</a></span>compute_fermion_det()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine global_mod::compute_fermion_det </td>
          <td>(</td>
          <td class="paramtype">complex (kind=kind(0.d0)), dimension(:), intent(out)&#160;</td>
          <td class="paramname"><em>Phase_det</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real (kind=kind(0.d0)), dimension(:,:), intent(out)&#160;</td>
          <td class="paramname"><em>Det_Vec</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">class(udv_state), dimension(:), intent(inout), allocatable&#160;</td>
          <td class="paramname"><em>udvl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">class(udv_state), dimension(:,:), intent(inout), allocatable&#160;</td>
          <td class="paramname"><em>udvst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(:), intent(in), allocatable&#160;</td>
          <td class="paramname"><em>Stab_nt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">character (len=64), intent(in)&#160;</td>
          <td class="paramname"><em>storage</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Computes the fermion determinant from scratch or from the storage. </p>
<dl class="section author"><dt>Author</dt><dd></dd></dl>
<pre class="fragment"> Finite temperature: If the storage is full then computes  det( 1 +  VL*DL*UL^{dag} )= Phase_det*e^{ \sum_{n=1}^{ndim} Det_vec(n) }
                     Note that  Udvl%U = UL, Udvl%D = DL and  Udvl%V = VL^{dag}
                     If storage is empty one first computes  Udvl and in doing so fills up the storage.
 Zero temperature:   If storage is full then computes  det \Psi_L U(\theta_tot,0) \Psi_R  =  Phase_det*e^{ \sum_{n=1}^{N_part} Det_vec(n) }
                     For the projective code the required scales which one can throw away for the Green function are in udvst.
                     If the storage is not full, then things will be computed from scratch and intermediate results will be stored in udvst.</pre><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">udvl,udvr</td><td>Class(UDV_State) <pre class="fragment">  If storage=Full  : On entry and exit udvl contains the last udv decomposition such that G=(1 + VL*DL*UL^{dag})^{-1}
  If storage=Empty : On exit udv1 will contain the last udv decomposition such that G=(1 + VL*DL*UL^{dag})^{-1}</pre> </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">Phase_det</td><td>Complex, Dimension(N_FL) <pre class="fragment">  The phase, per flavor </pre> </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">Det_vec</td><td>Real, Dimension(:,N_FL) </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">Stab_nt</td><td>Integer, Dimension(:) <pre class="fragment">  List of time slices for stabilization.</pre> </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">Storage</td><td>Character <pre class="fragment">  storage = "Full".  Compute the fermion det  with the use of the storage.
  storage = "Empty". Compute the fermion det from scratch and  in doing so, fill the storage.</pre> </td></tr>
  </table>
  </dd>
</dl>
<p>Local variables </p>

<p class="definition">Definition at line <a class="el" href="Global__mod_8f90_source.html#l00794">794</a> of file <a class="el" href="Global__mod_8f90_source.html">Global_mod.f90</a>.</p>

<p class="reference">References <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00139">hamiltonian::n_fl</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00138">hamiltonian::ndim</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00143">hamiltonian::projector</a>, <a class="el" href="UDV__WRAP_8f90_source.html#l00213">udv_wrap_mod::udv_wrap()</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00135">hamiltonian::wf_l</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00136">hamiltonian::wf_r</a>, and <a class="el" href="wrapul_8f90_source.html#l00033">wrapul()</a>.</p>

<p class="reference">Referenced by <a class="el" href="Global__mod_8f90_source.html#l00071">exchange_step()</a>, and <a class="el" href="Global__mod_8f90_source.html#l00494">global_updates()</a>.</p>
<div class="fragment"><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;<span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        <span class="keywordtype">Use  </span><a class="code" href="namespaceudv__wrap__mod.html">udv_wrap_mod</a></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;        <span class="keywordtype">Use </span><a class="code" href="namespaceudv__state__mod.html">udv_state_mod</a></div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        </div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        <span class="keywordtype">Implicit none</span></div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        </div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        <span class="keywordtype">REAL    (Kind=Kind(0.d0))</span>, <span class="keywordtype">Dimension(:,:)</span>, <span class="keywordtype">Intent(OUT)</span>  ::  Det_Vec</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;        <span class="keywordtype">Complex (Kind=Kind(0.d0))</span>, <span class="keywordtype">Dimension(:)</span>  , <span class="keywordtype">Intent(OUT)</span>  ::  Phase_det</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;        <span class="keywordtype">CLASS</span>(UDV_State), <span class="keywordtype">DIMENSION(:)</span>  , <span class="keywordtype">ALLOCATABLE</span>,  <span class="keywordtype">INTENT(INOUT)</span> :: udvl</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;        <span class="keywordtype">CLASS</span>(UDV_State), <span class="keywordtype">Dimension(:,:)</span>, <span class="keywordtype">ALLOCATABLE</span>,  <span class="keywordtype">INTENT(INOUT)</span> :: udvst</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;        <span class="keywordtype">INTEGER</span>,          <span class="keywordtype">dimension(:)</span>,   <span class="keywordtype">allocatable</span>,    <span class="keywordtype">INTENT(IN)</span>  :: Stab_nt</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;        <span class="keywordtype">Character (Len=64)</span>, <span class="keywordtype">Intent(IN)</span> :: storage </div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;        </div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;        <span class="keywordtype">Integer</span> ::  N_size, NCON, I,  J, N_part, info, NSTM, N, nf, nst, nt, nt1</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        <span class="keywordtype">Integer</span>, <span class="keywordtype">allocatable</span> :: ipiv(:)</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        <span class="keywordtype">COMPLEX (Kind=Kind(0.d0))</span> :: alpha,beta, Z, Z1</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;        <span class="keywordtype">TYPE</span>(UDV_State) :: udvlocal</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;        <span class="keywordtype">COMPLEX (Kind=Kind(0.d0))</span>, <span class="keywordtype">Dimension(:,:)</span>, <span class="keywordtype">Allocatable</span> ::  TP<span class="comment">!, U, V</span></div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;        <span class="keywordtype">COMPLEX (Kind=Kind(0.d0))</span>, <span class="keywordtype">Dimension(:)</span>, <span class="keywordtype">Allocatable</span> :: D</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        </div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;        <span class="keywordflow">if</span>(udvl(1)%side .ne. <span class="stringliteral">&quot;L&quot;</span> .and. udvl(1)%side .ne. <span class="stringliteral">&quot;l&quot;</span> ) <span class="keywordflow">then</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;           <span class="keyword">write</span>(*,*) <span class="stringliteral">&quot;calling wrong decompose&quot;</span></div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;           stop</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;        nstm = <span class="keyword">Size</span>(udvst, 1)</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;        <span class="keywordflow">If</span> (storage == <span class="stringliteral">&quot;Empty&quot;</span> ) <span class="keywordflow">then</span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;           <span class="keywordflow">DO</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;              <span class="keywordflow">if</span> (<a class="code" href="namespacehamiltonian.html#a77179b40953aaf13f002b7f4fc0b7456">projector</a>) <span class="keywordflow">then</span></div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                 <span class="keyword">CALL </span>udvl(nf)%reset(<span class="stringliteral">&#39;l&#39;</span>,<a class="code" href="namespacehamiltonian.html#a3c2ccadb9ff957e46da6a1b7484755f1">wf_l</a>(nf)%P)</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                 <span class="keyword">CALL </span>udvl(nf)%reset(<span class="stringliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;<span class="keywordflow">           ENDDO</span></div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;           <span class="keywordflow">DO</span> nst = nstm-1,1,-1</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;              nt1 = stab_nt(nst+1)</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;              nt  = stab_nt(nst  )</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;              <span class="comment">!Write(6,*) NT1,NT, NST</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;              <span class="keyword">CALL </span><a class="code" href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a>(nt1,nt, udvl)</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;              <span class="keywordflow">Do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;                 udvst(nst, nf) = udvl(nf)</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="keywordflow">              ENDDO</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;<span class="keywordflow">           ENDDO</span></div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;           nt1 = stab_nt(1)</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;           <span class="keyword">CALL </span><a class="code" href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a>(nt1,0, udvl)           </div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;<span class="keywordflow">        Endif</span></div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;        </div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="namespacehamiltonian.html#a77179b40953aaf13f002b7f4fc0b7456">projector</a>) <span class="keywordflow">then</span></div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;           n_part=udvst(1,1)%N_part</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;           n_size=udvl(1)%ndim</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;           <span class="keyword">Allocate</span> (tp(n_part,n_part), ipiv(n_part))</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;           <span class="keywordflow">do</span> nf=1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;              n_part=udvst(1,nf)%N_part</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;              <span class="keywordflow">do</span> i=1,nstm-1</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;                 <span class="keywordflow">do</span> n=1,n_part</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="preprocessor">#if !defined(LOG)</span></div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="preprocessor"></span>                    det_vec(n,nf)=det_vec(n,nf)+log(dble(udvst(i,nf)%D(n)))</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;<span class="preprocessor"></span>                    det_vec(n,nf)=det_vec(n,nf)+udvst(i,nf)%L(n)</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;<span class="preprocessor"></span><span class="keywordflow">                 enddo</span></div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;<span class="keywordflow">              enddo</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;              <span class="keywordflow">do</span> n=1,n_part</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;<span class="preprocessor">#if !defined(LOG)</span></div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;<span class="preprocessor"></span>                 det_vec(n,nf)=det_vec(n,nf)+log(dble(udvl(nf)%D(n)))</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;<span class="preprocessor"></span>                 det_vec(n,nf)=det_vec(n,nf)+udvl(nf)%L(n)</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;<span class="preprocessor"></span><span class="keywordflow">              enddo</span></div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;              alpha=1.d0</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;              <a class="code" href="namespacehamiltonian.html#aaf05c9e78bee7d0e443c116d5d517750">beta</a>=0.d0</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;              <span class="keyword">CALL </span>zgemm(<span class="stringliteral">&#39;C&#39;</span>,<span class="stringliteral">&#39;N&#39;</span>,n_part,n_part,n_size,alpha,udvl(nf)%U(1,1),n_size,<a class="code" href="namespacehamiltonian.html#adbb663a56d63496d9b9f883e84d527ed">wf_r</a>(nf)%P(1,1),n_size,<a class="code" href="namespacehamiltonian.html#aaf05c9e78bee7d0e443c116d5d517750">beta</a>,tp(1,1),n_part)</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;              <span class="comment">! ZGETRF computes an LU factorization of a general M-by-N matrix A</span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;              <span class="comment">! using partial pivoting with row interchanges.</span></div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;              <span class="keyword">call </span>zgetrf(n_part, n_part, tp(1,1), n_part, ipiv, info)</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;              z=1.d0</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;              <span class="keywordflow">Do</span> j=1,n_part</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;                 <span class="keywordflow">if</span> (ipiv(j).ne.j) <span class="keywordflow">then</span></div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;                    z = -z</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;<span class="keywordflow">                 endif</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;                 z =  z * tp(j,j)</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;<span class="keywordflow">              enddo</span></div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;              phase_det(nf) = z/abs(z)</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;              det_vec(1,nf) = det_vec(1,nf)+log(abs(z))</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;<span class="keywordflow">           enddo</span></div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;           <span class="keyword">Deallocate</span>(tp,ipiv)</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;           <span class="keywordflow">return</span></div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        </div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        <span class="comment">!    N_size = SIZE(DL,1)</span></div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        n_size = udvl(1)%ndim</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        ncon  = 0</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;        alpha = cmplx(1.d0,0.d0,kind(0.d0))</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        <a class="code" href="namespacehamiltonian.html#aaf05c9e78bee7d0e443c116d5d517750">beta</a>  = cmplx(0.d0,0.d0,kind(0.d0))</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;        <span class="keyword">Allocate</span> (tp(n_size,n_size),d(n_size))</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;        <span class="keyword">CALL </span>udvlocal%alloc(n_size)  </div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;        <span class="keywordflow">Do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;           tp = udvl(nf)%U <span class="comment">!udvl stores U^dag instead of U !CT(udvl%U)</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;<span class="preprocessor">#if !defined(LOG)</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if !defined(STAB3)</span></div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;<span class="preprocessor"></span>           <span class="keywordflow">DO</span> j = 1,n_size</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;              tp(:,j) = tp(:,j) +  udvl(nf)%V(:,j)*udvl(nf)%D(j)</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;<span class="keywordflow">           ENDDO</span></div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;<span class="preprocessor"></span>           <span class="keywordflow">DO</span> j = 1,n_size</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;              <span class="keywordflow">if</span> ( dble(udvl(nf)%D(j)) &lt;= 1.d0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                 tp(:,j) = tp(:,j) +  udvl(nf)%V(:,j)*udvl(nf)%D(j)</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                 tp(:,j) = tp(:,j)/udvl(nf)%D(j) +  udvl(nf)%V(:,j)</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;<span class="keywordflow">           ENDDO</span></div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;<span class="preprocessor"></span>           <span class="keywordflow">DO</span> j = 1,n_size</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;              <span class="keywordflow">if</span> ( udvl(nf)%L(j) &lt;= 0.d0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                 tp(:,j) = tp(:,j) +  udvl(nf)%V(:,j)*cmplx(exp(udvl(nf)%L(j)),0.d0,kind(0.d0))</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                 tp(:,j) = tp(:,j)*cmplx(exp(-udvl(nf)%L(j)),0.d0,kind(0.d0)) +  udvl(nf)%V(:,j)</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;<span class="keywordflow">           ENDDO</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;<span class="preprocessor"></span></div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;           <span class="comment">!Call  UDV_WRAP_Pivot(TP,udvlocal%U, D, udvlocal%V, NCON,N_size,N_Size)</span></div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;           <span class="keyword">Call  </span><a class="code" href="namespaceudv__wrap__mod.html#a1cb7953d6199fbd9f08310e161437a24">udv_wrap</a>(tp,udvlocal%U, d, udvlocal%V, ncon )</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;           z  = det_c(udvlocal%V, n_size) <span class="comment">! Det destroys its argument</span></div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;           <span class="comment">!         Call MMULT(TP, udvl%U, udvlocal%U)</span></div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;           <span class="keyword">CALL </span>zgemm(<span class="stringliteral">&#39;C&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, n_size, n_size, n_size, alpha, udvl(nf)%U(1,1), n_size, udvlocal%U(1,1), n_size, <a class="code" href="namespacehamiltonian.html#aaf05c9e78bee7d0e443c116d5d517750">beta</a>, tp, n_size)</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;           z1 = det_c(tp, n_size) </div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;           phase_det(nf)   = z*z1/abs(z*z1)</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;<span class="preprocessor">#if !defined(LOG)</span></div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#if !defined(STAB3)</span></div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;<span class="preprocessor"></span>           det_vec(:,nf) = log(<span class="keywordtype">real</span>(D(:)))</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;           det_vec(1,nf) = log(<span class="keywordtype">real</span>(D(1))) + log(ABS(Z*Z1))</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;<span class="preprocessor"></span>           det_vec(1,nf) = log(<span class="keywordtype">real</span>(D(1))*ABS(Z*Z1))</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;           <span class="keywordflow">if</span> (dble(udvl(nf)%D(1)) &gt; 1.d0) det_vec(1,nf)=det_vec(1,nf)+log(dble(udvl(nf)%D(1)))</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;           <span class="keywordflow">Do</span> j=2,<a class="code" href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">ndim</a></div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;              <span class="keywordflow">if</span> (dble(udvl(nf)%D(j))&lt;=1.d0) <span class="keywordflow">then</span></div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;                 det_vec(j,nf) = log(<span class="keywordtype">real</span>(D(J)))</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;                 det_vec(j,nf) = log(<span class="keywordtype">real</span>(D(J)))+log(dble(udvl(nf)%D(J)))</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="keywordflow">           enddo</span></div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="preprocessor"></span>           det_vec(1,nf) = log(<span class="keywordtype">real</span>(D(1))*ABS(Z*Z1))</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;           <span class="keywordflow">if</span> (udvl(nf)%L(1) &gt; 0.d0) det_vec(1)=det_vec(1)+udvl(nf)%L(1)</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;           <span class="keywordflow">Do</span> j=2,<a class="code" href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">ndim</a></div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;              <span class="keywordflow">if</span> (udvl(nf)%L(j)&lt;=0.d0) <span class="keywordflow">then</span></div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;                 det_vec(j,nf) = log(<span class="keywordtype">real</span>(D(J)))</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;                 det_vec(j,nf) = log(<span class="keywordtype">real</span>(D(J)))+udvl(nf)%L(J)</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;<span class="keywordflow">           enddo</span></div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="preprocessor"></span><span class="keywordflow">        Enddo</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        <span class="keyword">Deallocate</span> (tp)</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;        <span class="keyword">CALL </span>udvlocal%dealloc</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        </div><div class="ttc" id="namespacehamiltonian_html_aaf05c9e78bee7d0e443c116d5d517750"><div class="ttname"><a href="namespacehamiltonian.html#aaf05c9e78bee7d0e443c116d5d517750">hamiltonian::beta</a></div><div class="ttdeci">real(kind=kind(0.d0)), private beta</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00153">Hamiltonian_Examples.f90:153</a></div></div>
<div class="ttc" id="wrapul_8f90_html_a6c424a08cbc18006fdfedb1a344ad245"><div class="ttname"><a href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a></div><div class="ttdeci">subroutine wrapul(NTAU1, NTAU, UDVL)</div><div class="ttdef"><b>Definition:</b> <a href="wrapul_8f90_source.html#l00033">wrapul.f90:33</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_af508f251b4965d458d35546984d69fb2"><div class="ttname"><a href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">hamiltonian::n_fl</a></div><div class="ttdeci">integer n_fl</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00139">Hamiltonian_Examples.f90:139</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a13c80692ce5836cdc65570c6c56b0801"><div class="ttname"><a href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">hamiltonian::ndim</a></div><div class="ttdeci">integer ndim</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00138">Hamiltonian_Examples.f90:138</a></div></div>
<div class="ttc" id="namespaceudv__wrap__mod_html_a1cb7953d6199fbd9f08310e161437a24"><div class="ttname"><a href="namespaceudv__wrap__mod.html#a1cb7953d6199fbd9f08310e161437a24">udv_wrap_mod::udv_wrap</a></div><div class="ttdeci">subroutine udv_wrap(A, U, D, V, NCON)</div><div class="ttdef"><b>Definition:</b> <a href="UDV__WRAP_8f90_source.html#l00213">UDV_WRAP.f90:213</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a3c2ccadb9ff957e46da6a1b7484755f1"><div class="ttname"><a href="namespacehamiltonian.html#a3c2ccadb9ff957e46da6a1b7484755f1">hamiltonian::wf_l</a></div><div class="ttdeci">type(wavefunction), dimension(:), allocatable wf_l</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00135">Hamiltonian_Examples.f90:135</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a77179b40953aaf13f002b7f4fc0b7456"><div class="ttname"><a href="namespacehamiltonian.html#a77179b40953aaf13f002b7f4fc0b7456">hamiltonian::projector</a></div><div class="ttdeci">logical projector</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00143">Hamiltonian_Examples.f90:143</a></div></div>
<div class="ttc" id="namespaceudv__state__mod_html"><div class="ttname"><a href="namespaceudv__state__mod.html">udv_state_mod</a></div><div class="ttdoc">Handles UDV decompositions. </div><div class="ttdef"><b>Definition:</b> <a href="udv__state_8F90_source.html#l00044">udv_state.F90:44</a></div></div>
<div class="ttc" id="namespaceudv__wrap__mod_html"><div class="ttname"><a href="namespaceudv__wrap__mod.html">udv_wrap_mod</a></div><div class="ttdoc">This module contains two version of the stabilization. </div><div class="ttdef"><b>Definition:</b> <a href="UDV__WRAP_8f90_source.html#l00043">UDV_WRAP.f90:43</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_adbb663a56d63496d9b9f883e84d527ed"><div class="ttname"><a href="namespacehamiltonian.html#adbb663a56d63496d9b9f883e84d527ed">hamiltonian::wf_r</a></div><div class="ttdeci">type(wavefunction), dimension(:), allocatable wf_r</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00136">Hamiltonian_Examples.f90:136</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ab177641a883cf4886d53bf0ec95b3247"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab177641a883cf4886d53bf0ec95b3247">&#9670;&nbsp;</a></span>compute_ratio_global()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">complex (kind=kind(0.d0)) function global_mod::compute_ratio_global </td>
          <td>(</td>
          <td class="paramtype">complex (kind=kind(0.d0)), dimension(:), intent(in), allocatable&#160;</td>
          <td class="paramname"><em>Phase_Det_old</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">complex (kind=kind(0.d0)), dimension(:), intent(in), allocatable&#160;</td>
          <td class="paramname"><em>Phase_Det_new</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real (kind=kind(0.d0)), dimension(:,:), intent(in), allocatable&#160;</td>
          <td class="paramname"><em>Det_vec_old</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real (kind=kind(0.d0)), dimension(:,:), intent(in), allocatable&#160;</td>
          <td class="paramname"><em>Det_vec_new</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">class (fields), intent(in), allocatable&#160;</td>
          <td class="paramname"><em>nsigma_old</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real (kind=kind(0.d0)), intent(in)&#160;</td>
          <td class="paramname"><em>T0_Proposal_ratio</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">complex (kind=kind(0.d0)), dimension(2), intent(out)&#160;</td>
          <td class="paramname"><em>Ratio</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This fucntion computes ratio of weights for global moves. </p>
<dl class="section author"><dt>Author</dt><dd>The ALF Project contributors</dd></dl>
<pre class="fragment">  Ratio_Global = T0(nsigma--&gt; nsigma_old) W(nsigma)/T0(nsigma_old--&gt; nsigma) W(nsigma_old) = 
                 T0_Proposal_ratio   W(nsigma)/  W(nsigma_old)
  On entry the old and new fermion determinants read: Phase_det*e^{ \sum_{n=1}^{ndim} Det_vec(n) }
  as obtained from the Compute_Fermion_det routine.
  On exit Ratio_Global = Ratio(1)*exp(Ratio(2))</pre><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">Phase_det_new</td><td>Complex, Dimension(N_FL) </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">Phase_det_old</td><td>Complex, Dimension(N_FL) </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">Det_vec_new</td><td>Real, Dimension(:,N_FL) </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">Det_vec_old</td><td>Real, Dimension(:,N_FL) </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">T0_proposal_ratio</td><td>Real </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nsigma_old</td><td>Class(Fields) <pre class="fragment">  Old configuration. The new configuration is stored in nsigma. nsigma is a globale variable
  contained in the Hamiltonian module.</pre> </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="Global__mod_8f90_source.html#l00699">699</a> of file <a class="el" href="Global__mod_8f90_source.html">Global_mod.f90</a>.</p>

<p class="reference">References <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00848">hamiltonian::delta_s0_global()</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00141">hamiltonian::ltrot</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00139">hamiltonian::n_fl</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00140">hamiltonian::n_sun</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00138">hamiltonian::ndim</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00137">hamiltonian::nsigma</a>, and <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00133">hamiltonian::op_v</a>.</p>

<p class="reference">Referenced by <a class="el" href="Global__mod_8f90_source.html#l00071">exchange_step()</a>, and <a class="el" href="Global__mod_8f90_source.html#l00494">global_updates()</a>.</p>
<div class="fragment"><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    </div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        <span class="keywordtype">Implicit none</span></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;        </div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        <span class="comment">! Arguments</span></div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        <span class="keywordtype">Complex (Kind=Kind(0.d0))</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">INTENT(IN)</span> :: Phase_Det_old(:), Phase_Det_new(:)</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;        <span class="keywordtype">REAL    (Kind=Kind(0.d0))</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">INTENT(IN)</span> :: Det_vec_old(:,:), Det_vec_new(:,:)</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;        <span class="keywordtype">Real    (Kind=Kind(0.d0))</span>,    <span class="keywordtype">INTENT(IN)</span>  :: T0_proposal_ratio </div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;        class(<a class="code" href="structfields__mod_1_1fields.html">fields</a>), <span class="keywordtype">allocatable</span>,  <span class="keywordtype">INTENT(IN)</span>  :: nsigma_old</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;        <span class="keywordtype">Complex (Kind=Kind(0.d0))</span>,    <span class="keywordtype">INTENT(out)</span> :: Ratio(2)</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        </div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;        <span class="comment">! Local </span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        <span class="keywordtype">Integer</span>  :: Nf, i, nt</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;        <span class="keywordtype">Complex (Kind=Kind(0.d0))</span> :: Z, Z1</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        <span class="keywordtype">Real    (Kind=Kind(0.d0))</span> :: X, Ratio_2</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        </div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        ratio = cmplx(0.d0,0.d0,kind(0.d0))</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        ratio_2 = 0.d0</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        <span class="comment">!X = 1.d0</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        <span class="keywordflow">Do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;           <span class="keywordflow">DO</span> i = 1,<a class="code" href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">ndim</a></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;              <span class="comment">!X= X*real(Det_vec_new(I,nf),kind(0.d0)) / Real(Det_vec_old(I,nf),kind(0.d0) )</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;              ratio_2 = ratio_2 +  det_vec_new(i,nf) - det_vec_old(i,nf)</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;<span class="keywordflow">           enddo</span></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        <span class="comment">!Z = cmplx(X,0.d0,kind(0.d0))</span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        ratio(1) = cmplx(1.d0,0.d0,kind(0.d0))</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        <span class="keywordflow">Do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;           <span class="comment">!Z = Z*Phase_Det_new(nf)/Phase_Det_old(nf)</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;           ratio(1) = ratio(1) *  phase_det_new(nf)/phase_det_old(nf)</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        <span class="comment">!Z = Z**N_SUN </span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        ratio(1) = ratio(1)**<a class="code" href="namespacehamiltonian.html#ac8b556cb31a51119226fa1b1afa87eb1">n_sun</a></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        ratio_2 = <span class="keywordtype">real</span>(N_SUN,kind(0.d0))*Ratio_2</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;        </div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        <span class="keywordflow">Do</span> i = 1,<span class="keyword">Size</span>(<a class="code" href="namespacehamiltonian.html#a784fd999e79bf7eea97eb4b7695db65d">op_v</a>,1)</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;           x = 0.d0</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;           <span class="keywordflow">Do</span> nt = 1,<a class="code" href="namespacehamiltonian.html#a643cec8e88998409a6f5ae27915b5e87">ltrot</a></div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;              <span class="comment">!Z = Z * cmplx( Gaml(nsigma(i,nt),2)/Gaml(nsigma_old(i,nt),2),0.d0,kind(0.d0) ) </span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;              ratio(1) = ratio(1) * cmplx( <a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>%Gama(i,nt)/nsigma_old%Gama(i,nt),0.d0,kind(0.d0) )  <span class="comment">!  You could put this in Ratio_2</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;              x = x + <a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>%Phi(i,nt) - nsigma_old%Phi(i,nt)</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;<span class="keywordflow">           Enddo</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;           <span class="keywordflow">Do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;              <span class="comment">!Z = Z * exp(cmplx( X*Real(N_SUN,Kind(0.d0)), 0.d0,kind(0.d0)) * Op_V(i,nf)%g * Op_V(i,nf)%alpha )</span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;              ratio(1) = ratio(1) * exp(cmplx( x*<span class="keywordtype">Real(N_SUN,Kind(0.d0))</span>, 0.d0,kind(0.d0)) * Op_V(i,nf)%g * Op_V(i,nf)%alpha )</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;<span class="keywordflow">           Enddo</span></div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="keywordflow">        Enddo</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;        <span class="comment">!Z =  Z * cmplx( Delta_S0_global(Nsigma_old),0.d0,kind(0.d0) )</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        <span class="comment">!Z =  Z * cmplx( T0_Proposal_ratio, 0.d0,kind(0.d0))</span></div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;        ratio_2 = ratio_2 + log(<a class="code" href="namespacehamiltonian.html#af627770a99fbe09e6cf52af735e251ba">delta_s0_global</a>(nsigma_old)) + log(t0_proposal_ratio)</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;        </div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;        ratio(2) = ratio_2</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        compute_ratio_global = ratio(1)*exp(ratio(2))</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;        </div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        </div><div class="ttc" id="structfields__mod_1_1fields_html"><div class="ttname"><a href="structfields__mod_1_1fields.html">fields_mod::fields</a></div><div class="ttdef"><b>Definition:</b> <a href="Fields__mod_8f90_source.html#l00065">Fields_mod.f90:65</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a643cec8e88998409a6f5ae27915b5e87"><div class="ttname"><a href="namespacehamiltonian.html#a643cec8e88998409a6f5ae27915b5e87">hamiltonian::ltrot</a></div><div class="ttdeci">integer ltrot</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00141">Hamiltonian_Examples.f90:141</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_af508f251b4965d458d35546984d69fb2"><div class="ttname"><a href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">hamiltonian::n_fl</a></div><div class="ttdeci">integer n_fl</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00139">Hamiltonian_Examples.f90:139</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a47e39398314b7c8194c8736008fc447c"><div class="ttname"><a href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">hamiltonian::nsigma</a></div><div class="ttdeci">class(fields), allocatable nsigma</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00137">Hamiltonian_Examples.f90:137</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a13c80692ce5836cdc65570c6c56b0801"><div class="ttname"><a href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">hamiltonian::ndim</a></div><div class="ttdeci">integer ndim</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00138">Hamiltonian_Examples.f90:138</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a784fd999e79bf7eea97eb4b7695db65d"><div class="ttname"><a href="namespacehamiltonian.html#a784fd999e79bf7eea97eb4b7695db65d">hamiltonian::op_v</a></div><div class="ttdeci">type(operator), dimension(:,:), allocatable op_v</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00133">Hamiltonian_Examples.f90:133</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_ac8b556cb31a51119226fa1b1afa87eb1"><div class="ttname"><a href="namespacehamiltonian.html#ac8b556cb31a51119226fa1b1afa87eb1">hamiltonian::n_sun</a></div><div class="ttdeci">integer n_sun</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00140">Hamiltonian_Examples.f90:140</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_af627770a99fbe09e6cf52af735e251ba"><div class="ttname"><a href="namespacehamiltonian.html#af627770a99fbe09e6cf52af735e251ba">hamiltonian::delta_s0_global</a></div><div class="ttdeci">real(kind=kind(0.d0)) function delta_s0_global(Nsigma_old)</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00848">Hamiltonian_Examples.f90:848</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a090aa1cf2445e51b1315808df6eb028c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a090aa1cf2445e51b1315808df6eb028c">&#9670;&nbsp;</a></span>exchange_step()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine global_mod::exchange_step </td>
          <td>(</td>
          <td class="paramtype">complex (kind=kind(0.d0)), intent(inout)&#160;</td>
          <td class="paramname"><em>Phase</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">complex (kind=kind(0.d0)), dimension(:,:,:), intent(inout), allocatable&#160;</td>
          <td class="paramname"><em>GR</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">class(udv_state), dimension(:), intent(inout), allocatable&#160;</td>
          <td class="paramname"><em>udvr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">class(udv_state), dimension(:), intent(inout), allocatable&#160;</td>
          <td class="paramname"><em>udvl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(:), intent(in), allocatable&#160;</td>
          <td class="paramname"><em>Stab_nt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">class(udv_state), dimension(:, :), intent(inout), allocatable&#160;</td>
          <td class="paramname"><em>udvst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>N_exchange_steps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical&#160;</td>
          <td class="paramname"><em>Tempering_calc_det</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Handles parrallel tempering This subroutine is called only if the tempering flag is switched on. </p>
<dl class="section author"><dt>Author</dt><dd>ALF-project In this case the MPI flag is also switched on.</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">phase</td><td>Arguments</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">n_exchange_steps</td><td>Local variables.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">tempering_calc_det</td><td>Additional variables for running without Fermion weight </td></tr>
  </table>
  </dd>
</dl>
<p>Compute for each core the old weights. <br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 Store old configuration</p>
<p>Set the partner rank on each core</p>
<p>Exchange configurations</p>
<p>Each node now has a new configuration nsigma</p>
<p>Compute ratio on weights one each rank</p>
<p>Acceptace/rejection decision taken on master node after receiving information from slave</p>
<p>Send result of acceptance/rejection decision form master to slave</p>
<p>Move has been accepted</p>
<p>Finalize</p>
<p>If move has been accepted, no use to recomute storage</p>
<p>Compute the Green functions so as to provide correct starting point for the sequential updates.</p>
<p>Send &gt;&gt;Phase, GR, udvr, udvl, udvst&lt;&lt; to new node </p>

<p class="definition">Definition at line <a class="el" href="Global__mod_8f90_source.html#l00071">71</a> of file <a class="el" href="Global__mod_8f90_source.html">Global_mod.f90</a>.</p>

<p class="reference">References <a class="el" href="cgr1_8f90_source.html#l00033">cgr()</a>, <a class="el" href="Global__mod_8f90_source.html#l00794">compute_fermion_det()</a>, <a class="el" href="Global__mod_8f90_source.html#l00699">compute_ratio_global()</a>, <a class="el" href="control__mod_8f90_source.html#l00109">control::control_upgrade_temp()</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00848">hamiltonian::delta_s0_global()</a>, <a class="el" href="Global__mod_8f90_source.html#l01006">global_tempering_obser()</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00144">hamiltonian::group_comm</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00139">hamiltonian::n_fl</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00140">hamiltonian::n_sun</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00138">hamiltonian::ndim</a>, <a class="el" href="Global__mod_8f90_source.html#l00963">npbc_tempering()</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00137">hamiltonian::nsigma</a>, <a class="el" href="Operator_8f90_source.html#l00151">operator_mod::op_phase()</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00133">hamiltonian::op_v</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00143">hamiltonian::projector</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00135">hamiltonian::wf_l</a>, and <a class="el" href="wrapul_8f90_source.html#l00033">wrapul()</a>.</p>

<p class="reference">Referenced by <a class="el" href="main_8f90_source.html#l00033">main()</a>.</p>
<div class="fragment"><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        <span class="keywordtype">Use </span><a class="code" href="namespaceudv__state__mod.html">udv_state_mod</a></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        <span class="keywordtype">Use </span>mpi</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        <span class="keywordtype">Implicit none</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        <span class="keyword">Interface</span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="keyword">           SUBROUTINE </span><a class="code" href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a>(NTAU1, NTAU, udvl)</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;             <span class="keywordtype">Use </span><a class="code" href="namespacehamiltonian.html">hamiltonian</a></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;             <span class="keywordtype">Use </span><a class="code" href="namespaceudv__state__mod.html">udv_state_mod</a></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;             <span class="keywordtype">Implicit none</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;             <span class="keywordtype">CLASS</span>(UDV_State), <span class="keywordtype">intent(inout)</span> :: udvl(N_FL)</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;             <span class="keywordtype">Integer</span> :: NTAU1, NTAU</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="keyword">           END SUBROUTINE </span><a class="code" href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="keyword">           SUBROUTINE </span><a class="code" href="cgr1_8f90.html#ada6af176b0e7c9a3b0c19ebb798b3231">cgr</a>(PHASE,NVAR, GRUP, udvr, udvl)</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;             <span class="keywordtype">Use </span><a class="code" href="namespaceudv__wrap__mod.html">udv_wrap_mod</a></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;             <span class="keywordtype">Use </span><a class="code" href="namespaceudv__state__mod.html">udv_state_mod</a></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;             <span class="keywordtype">Implicit None</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;             <span class="keywordtype">CLASS</span>(UDV_State), <span class="keywordtype">INTENT(IN)</span> :: udvl, udvr</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;             <span class="keywordtype">COMPLEX(Kind=Kind(0.d0))</span>, <span class="keywordtype">Dimension(:,:)</span>, <span class="keywordtype">Intent(Inout)</span> :: GRUP</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;             <span class="keywordtype">COMPLEX(Kind=Kind(0.d0))</span> :: PHASE</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;             <span class="keywordtype">INTEGER</span>         :: NVAR</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="keyword">           END SUBROUTINE </span><a class="code" href="cgr1_8f90.html#ada6af176b0e7c9a3b0c19ebb798b3231">cgr</a></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="keyword">        end Interface</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        </div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        <span class="keywordtype">COMPLEX (Kind=Kind(0.d0))</span>, <span class="keywordtype">INTENT(INOUT)</span>                   :: Phase</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        <span class="keywordtype">CLASS</span>(UDV_State), <span class="keywordtype">intent(inout)</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">Dimension(:)</span> :: udvl, udvr</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        <span class="keywordtype">COMPLEX (Kind=Kind(0.d0))</span>, <span class="keywordtype">Dimension(:,:,:)</span>, <span class="keywordtype">INTENT(INOUT)</span>, <span class="keywordtype">allocatable</span> :: GR</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        <span class="keywordtype">CLASS</span>(UDV_State), <span class="keywordtype">intent(inout)</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">Dimension(:, :)</span> :: udvst</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <span class="keywordtype">INTEGER</span>, <span class="keywordtype">dimension(:)</span>,     <span class="keywordtype">INTENT   (IN)</span>, <span class="keywordtype">allocatable</span>      :: Stab_nt</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        </div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        </div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        <span class="keywordtype">Integer</span> :: NST, NSTM, NF, NT, NT1, NVAR,N, N1,N2, I, NC, I_Partner, n_step, N_exchange_steps, N_count, N_part</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        <span class="keywordtype">Integer</span>, <span class="keywordtype">Dimension(:,:)</span>,  <span class="keywordtype">allocatable</span> :: nsigma_old</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        <span class="keywordtype">Real    (Kind=Kind(0.d0))</span> :: T0_Proposal_ratio, Weight, Weight1</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        <span class="keywordtype">Complex (Kind=Kind(0.d0))</span> :: Z_ONE = cmplx(1.d0, 0.d0, kind(0.d0)), z, ratiotot, ratiotot_p, phase_old, phase_new</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        <span class="keywordtype">Real    (Kind=Kind(0.d0))</span>, <span class="keywordtype">allocatable</span> :: Det_vec_old(:,:), Det_vec_new(:,:)</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        <span class="keywordtype">Complex (Kind=Kind(0.d0))</span>, <span class="keywordtype">allocatable</span> :: Phase_Det_new(:), Phase_Det_old(:)</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        <span class="keywordtype">Complex (Kind=Kind(0.d0))</span> :: Ratio(2), Ratio_p(2)</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        <span class="keywordtype">Logical</span> :: TOGGLE, L_Test</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        <span class="keywordtype">Integer</span>, <span class="keywordtype">allocatable</span> :: List_partner(:), List_masters(:)</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <span class="keywordtype">Logical</span> :: Tempering_calc_det</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <span class="comment">! Keep track of where the configuration originally came from</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        <span class="keywordtype">Integer</span>        :: nsigma_irank, nsigma_old_irank, nsigma_irank_temp</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        <span class="keywordtype">Integer</span>        :: n_GR</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="comment">!Integer, Dimension(:,:),  allocatable :: nsigma_orig, nsigma_test</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        <span class="comment">!Integer :: I1, I2</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        <span class="keywordtype">Integer</span>        :: Isize, Irank, Ierr, irank_g, isize_g, igroup</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        <span class="keywordtype">Integer</span>        :: STATUS(MPI_STATUS_SIZE)</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <span class="keyword">CALL </span>mpi_comm_size(mpi_comm_world,isize,ierr)</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        <span class="keyword">CALL </span>mpi_comm_rank(mpi_comm_world,irank,ierr)</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        <span class="keyword">call </span>mpi_comm_rank(<a class="code" href="namespacehamiltonian.html#aef693c8b68751ed1e8ffc50b12890e02">group_comm</a>, irank_g, ierr)</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="keyword">call </span>mpi_comm_size(<a class="code" href="namespacehamiltonian.html#aef693c8b68751ed1e8ffc50b12890e02">group_comm</a>, isize_g, ierr)</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        igroup           = irank/isize_g</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        nsigma_irank = irank</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        n1 = <span class="keyword">size</span>(<a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>,1)</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        n2 = <span class="keyword">size</span>(<a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>,2)</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        nstm = <span class="keyword">Size</span>(udvst, 1)</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        <span class="keyword">Allocate</span> ( nsigma_old(n1,n2) )</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        <span class="keywordflow">if</span> (tempering_calc_det) <span class="keywordflow">then</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;           <span class="keyword">Allocate</span> ( det_vec_old(<a class="code" href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">ndim</a>,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a>), det_vec_new(<a class="code" href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">ndim</a>,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a>) ) </div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;           <span class="keyword">Allocate</span> ( phase_det_new(<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a>), phase_det_old(<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a>) )</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        <span class="keyword">Allocate</span> ( list_partner(0:isize-1), list_masters(isize/2) )</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        </div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="comment">!         Allocate ( nsigma_orig(n1,n2) )</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        <span class="comment">!         nsigma_orig = nsigma</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        </div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        l_test = .false.</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="keywordflow">if</span> (tempering_calc_det) <span class="keywordflow">then</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;           <span class="comment">! Set old weight. </span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;           det_vec_old=0.d0</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;           <span class="keywordflow">if</span> (<a class="code" href="namespacehamiltonian.html#a77179b40953aaf13f002b7f4fc0b7456">projector</a>) <span class="keywordflow">then</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;              <span class="keywordflow">do</span> nf=1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;                n_part=udvst(1,nf)%N_part</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;                <span class="keywordflow">do</span> i=1,nstm-1</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                  <span class="keywordflow">do</span> n=1,n_part</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="preprocessor">#if !defined(LOG)</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="preprocessor"></span>                    det_vec_old(n,nf)=det_vec_old(n,nf)+log(dble(udvst(i,nf)%D(n)))</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="preprocessor"></span>                    det_vec_old(n,nf)=det_vec_old(n,nf)+udvst(i,nf)%L(n)</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="preprocessor"></span><span class="keywordflow">                  enddo</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="keywordflow">                enddo</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="keywordflow">              enddo</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;              <span class="keywordflow">Do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                n_part=udvl(nf)%N_part</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                <span class="keywordflow">do</span> n=1,n_part</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="preprocessor">#if !defined(LOG)</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="preprocessor"></span>                    det_vec_new(n,nf)=det_vec_new(n,nf)+log(dble(udvl(nf)%D(n)))</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="preprocessor"></span>                    det_vec_new(n,nf)=det_vec_new(n,nf)+udvl(nf)%L(n)</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="preprocessor"></span><span class="keywordflow">                enddo</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="keywordflow">              ENDDO</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="keywordflow">           endif</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;           phase_old =cmplx(1.d0,0.d0,kind(0.d0))</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;           <span class="keywordflow">do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;              <span class="keyword">Call </span>compute_fermion_det(z,det_vec_old(:,nf), udvl(nf), nf)</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;              phase_det_old(nf) = z</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;              phase_old = phase_old*z</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="keywordflow">           Enddo</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;           <span class="keyword">call </span>op_phase(phase_old,<a class="code" href="namespacehamiltonian.html#a784fd999e79bf7eea97eb4b7695db65d">op_v</a>,<a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>,<a class="code" href="namespacehamiltonian.html#ac8b556cb31a51119226fa1b1afa87eb1">n_sun</a>) </div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        nsigma_old = <a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        nsigma_old_irank = nsigma_irank</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        <span class="comment">! Setup the list of masters</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        nc = 0</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        <span class="keywordflow">Do</span> i  = 0,isize-1,2*isize_g</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;           <span class="keywordflow">do</span> n = 0,isize_g-1</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;              nc = nc + 1</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;              list_masters(nc)  = i + n</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="keywordflow">           enddo</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="keywordflow">        Enddo</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="keywordflow">if</span> (l_test) <span class="keywordflow">then</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;           <span class="keywordflow">if</span> (irank == 0)  <span class="keywordflow">then</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;              <span class="keyword">Write</span>(6,*) <span class="stringliteral">&#39;List  of masters: &#39;</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;              <span class="keywordflow">Do</span> nc = 1,isize/2</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                 <span class="keyword">Write</span>(6,*) nc, list_masters(nc)</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="keywordflow">              Enddo</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="keywordflow">           endif</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        <span class="keywordflow">DO</span> n_count = 1,n_exchange_steps</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;           </div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;           <span class="keywordflow">If</span> (irank == 0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;              n_step = isize_g</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;              <span class="keywordflow">if</span> (  ranf_wrap() &gt; 0.5d0 ) n_step = -isize_g</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;              <span class="keywordflow">Do</span> i = 0,isize-1,2*isize_g</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                 <span class="keywordflow">do</span> n = 0,isize_g-1</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                    list_partner(npbc_tempering(i  + n             ,isize)) =  npbc_tempering(i +  n   + n_step,isize)</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                    list_partner(npbc_tempering(i  + n  + n_step  , isize)) =  npbc_tempering(i + n            ,isize)</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="keywordflow">                 enddo</span></div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="keywordflow">              enddo</span></div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="keywordflow">           endif</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;           <span class="keyword">CALL </span>mpi_bcast(list_partner, isize  ,mpi_integer,   0,mpi_comm_world,ierr)</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;           </div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;           <span class="keywordflow">If</span> (l_test) <span class="keywordflow">then</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;              <span class="keywordflow">if</span> (irank == 0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                 <span class="keyword">Write</span>(6,*) <span class="stringliteral">&#39;Testing global : &#39;</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;                 <span class="keywordflow">do</span>  i = 0,isize -1 </div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                    <span class="keyword">Write</span>(6,*)  i, list_partner(i) <span class="comment">!, Phase_old, Phase</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                    <span class="keyword">Write</span>(11,*)  i, list_partner(i) <span class="comment">!, Phase_old, Phase</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="keywordflow">                 enddo</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                 <span class="keyword">Write</span>(11,*)</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="keywordflow">           Endif</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;           <span class="comment">!call MPI_Barrier(MPI_COMM_WORLD)</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;           <span class="comment">!Write(6,*) &#39;---------&#39;</span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="comment">!!$    select case (IRANK)</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="comment">!!$    case(0)</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">!!$       nsigma_old(1,1) =  1;  nsigma_old(2,1) = 1</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">!!$    case(1)</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment">!!$       nsigma_old(1,1) = -1;  nsigma_old(2,1) = 1</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment">!!$    case(2)</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="comment">!!$       nsigma_old(1,1) =  1;  nsigma_old(2,1) = -1</span></div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">!!$    case(3)</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="comment">!!$       nsigma_old(1,1) = -1;  nsigma_old(2,1) = -1</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="comment">!!$    case default</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment">!!$    end select</span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    </div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;           n = <span class="keyword">size</span>(nsigma_old,1)*<span class="keyword">size</span>(nsigma_old,2)</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;           <span class="keyword">CALL </span>mpi_sendrecv(nsigma_old      , n, mpi_integer, list_partner(irank), 0, &amp;</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                    &amp;        <a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>          , n, mpi_integer, list_partner(irank), 0, mpi_comm_world,status,ierr)</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;           <span class="keyword">CALL </span>mpi_sendrecv(nsigma_old_irank, 1, mpi_integer, list_partner(irank), 0, &amp;</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                    &amp;        nsigma_irank    , 1, mpi_integer, list_partner(irank), 0, mpi_comm_world,status,ierr)</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;           </div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;           </div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="comment">!!$    If (L_test) then</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">!!$       Write(6,*) &#39;Testing global : &#39;, Irank,List_partner(IRANK), nsigma_old(1,1),  nsigma_old(2,1), nsigma(1,1),  nsigma(2,1) </span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="comment">!!$    Endif</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;           </div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;           </div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;           </div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="keywordflow">if</span> (tempering_calc_det) <span class="keywordflow">then</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;           <span class="keywordflow">DO</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;              <span class="keywordflow">if</span> (<a class="code" href="namespacehamiltonian.html#a77179b40953aaf13f002b7f4fc0b7456">projector</a>) <span class="keywordflow">then</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                <span class="keyword">CALL </span>udvl(nf)%reset(<span class="stringliteral">&#39;l&#39;</span>,<a class="code" href="namespacehamiltonian.html#a3c2ccadb9ff957e46da6a1b7484755f1">wf_l</a>(nf)%P)</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                <span class="keyword">CALL </span>udvl(nf)%reset(<span class="stringliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="keywordflow">           ENDDO</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;              <span class="comment">!! Compute detvec for projector</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;           det_vec_new=0.d0</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;           <span class="keywordflow">DO</span> nst = nstm-1,1,-1</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;              nt1 = stab_nt(nst+1)</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;              nt  = stab_nt(nst  )</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;              <span class="comment">!Write(6,*) NT1,NT, NST</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;              <span class="keyword">CALL </span><a class="code" href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a>(nt1,nt, udvl)</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;              <span class="keywordflow">Do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                 udvst(nst, nf) = udvl(nf)</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                 <span class="keywordflow">if</span> (<a class="code" href="namespacehamiltonian.html#a77179b40953aaf13f002b7f4fc0b7456">projector</a>) <span class="keywordflow">then</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                    n_part=udvl(nf)%N_part</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                    <span class="keywordflow">do</span> n=1,n_part</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="preprocessor">#if !defined(LOG)</span></div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="preprocessor"></span>                        det_vec_new(n,nf)=det_vec_new(n,nf)+log(dble(udvl(nf)%D(n)))</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="preprocessor"></span>                        det_vec_new(n,nf)=det_vec_new(n,nf)+udvl(nf)%L(n)</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="preprocessor"></span><span class="keywordflow">                    enddo</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="keywordflow">                 endif</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="keywordflow">              ENDDO</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="keywordflow">           ENDDO</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;           nt1 = stab_nt(1)</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;           <span class="keyword">CALL </span><a class="code" href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a>(nt1,0, udvl)</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;           <span class="keywordflow">if</span> (<a class="code" href="namespacehamiltonian.html#a77179b40953aaf13f002b7f4fc0b7456">projector</a>) <span class="keywordflow">then</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;              <span class="keywordflow">Do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                n_part=udvl(nf)%N_part</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                <span class="keywordflow">do</span> n=1,n_part</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="preprocessor">#if !defined(LOG)</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="preprocessor"></span>                    det_vec_new(n,nf)=det_vec_new(n,nf)+log(dble(udvl(nf)%D(n)))</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="preprocessor"></span>                    det_vec_new(n,nf)=det_vec_new(n,nf)+udvl(nf)%L(n)</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="preprocessor"></span><span class="keywordflow">                enddo</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="keywordflow">              ENDDO</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="keywordflow">           endif</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;           phase_new = cmplx(1.d0,0.d0,kind(0.d0))</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;           <span class="keywordflow">do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;              <span class="keyword">Call </span>compute_fermion_det(z,det_vec_new(:,nf), udvl(nf), nf)</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;              phase_det_new(nf) = z</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;              phase_new = phase_new*z</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="keywordflow">           Enddo</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;           <span class="keyword">call </span>op_phase(phase_new,<a class="code" href="namespacehamiltonian.html#a784fd999e79bf7eea97eb4b7695db65d">op_v</a>,<a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>,<a class="code" href="namespacehamiltonian.html#ac8b556cb31a51119226fa1b1afa87eb1">n_sun</a>) </div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;           </div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;           t0_proposal_ratio = 1.d0</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;           ratiotot = compute_ratio_global(phase_det_old, phase_det_new, &amp;</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                &amp;                               det_vec_old, det_vec_new, nsigma_old, t0_proposal_ratio,ratio) </div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;           </div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;           <span class="keywordflow">If</span> (l_test) <span class="keyword">Write</span>(6,*) <span class="stringliteral">&#39;Ratio_global: Irank, Partner&#39;</span>,irank,list_partner(irank), ratiotot, ratio(1)*exp(ratio(2))</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;           ratiotot = <a class="code" href="namespacehamiltonian.html#af627770a99fbe09e6cf52af735e251ba">delta_s0_global</a>(nsigma_old)</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;           ratio(1) = ratiotot</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;           ratio(2) = 0</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    </div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;           <span class="keywordflow">Do</span> nc = 1,isize/2 <span class="comment">! Loop over masters</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;              i = list_masters(nc)</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;              <span class="keywordflow">If</span> (irank == i ) <span class="keywordflow">Then</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                 <span class="comment">!CALL MPI_SEND(Ratiotot,1, MPI_COMPLEX16  , List_partner(I), I+512 , MPI_COMM_WORLD,IERR)</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                 <span class="keyword">CALL </span>mpi_send(ratio   ,2, mpi_complex16  , list_partner(i), i+1024, mpi_comm_world,ierr)</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;              <span class="keywordflow">else</span> <span class="keywordflow">if</span> (irank == list_partner(i) ) <span class="keywordflow">Then</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                 <span class="comment">!CALL MPI_RECV(Ratiotot_p , 1, MPI_COMPLEX16,  I, I+512 , MPI_COMM_WORLD,STATUS,IERR)</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                 <span class="keyword">CALL </span>mpi_recv(ratio_p    , 2, mpi_complex16,  i, i+1024, mpi_comm_world,status,ierr)</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                 <span class="comment">!Weight = abs(Ratiotot_p*Ratiotot)</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                 weight= abs(ratio(1) * ratio_p(1) * exp( ratio_p(2) + ratio(2)  ) )</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                 toggle = .false. </div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                 <span class="keywordflow">if</span> ( weight &gt; ranf_wrap() )  toggle =.true.</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                 <span class="keywordflow">If</span> (l_test) <span class="keyword">Write</span>(6,*) <span class="stringliteral">&#39;Master : &#39;</span>, list_partner(i), i, weight, toggle</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="keywordflow">           enddo</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;           </div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;           <span class="keywordflow">Do</span> nc =  1,isize/2 <span class="comment">! Loop over masters</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;              i = list_masters(nc)</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;              <span class="keywordflow">If</span> (irank == list_partner(i) ) <span class="keywordflow">Then</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                 <span class="comment">! Write(6,*) &#39;Send from &#39;, List_Partner(I), &#39;to, &#39;, I, I + 512</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                 <span class="keyword">CALL </span>mpi_send(toggle, 1, mpi_logical, i, i+512, mpi_comm_world,ierr)</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;              <span class="keywordflow">else</span> <span class="keywordflow">if</span> (irank == i ) <span class="keywordflow">Then</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                 <span class="keyword">CALL </span>mpi_recv(toggle , 1, mpi_logical,   list_partner(i), i+512 ,mpi_comm_world,status,ierr)</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                 <span class="keywordflow">If</span> (l_test) <span class="keyword">Write</span>(6,*) <span class="stringliteral">&#39;Slave : &#39;</span>, irank,  toggle</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="keywordflow">           enddo</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;           </div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;           <span class="keywordflow">If</span> (l_test) <span class="keyword">Write</span>(6,*) <span class="stringliteral">&#39;Final: &#39;</span>,  irank, list_partner(irank), toggle</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;           <span class="keyword">Call </span>global_tempering_obser(toggle)</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;           <span class="keyword">Call </span><a class="code" href="namespacecontrol.html#a1a7790e18650d734f1fc8ccff8cc3fe0">control_upgrade_temp</a>  (toggle) </div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;           <span class="keywordflow">If</span> (toggle)  <span class="keywordflow">then</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;              <span class="keywordflow">if</span> (tempering_calc_det) <span class="keywordflow">then</span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                 phase_old     = phase_new</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                 phase_det_old = phase_det_new</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                 det_vec_old   = det_vec_new</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;              nsigma_old       = <a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;              nsigma_old_irank = nsigma_irank</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;           <span class="keywordflow">else</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;              <a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>       = nsigma_old</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;              nsigma_irank = nsigma_old_irank</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="keywordflow">           endif</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        </div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        <span class="keywordflow">if</span> (tempering_calc_det) <span class="keywordflow">then</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;           <span class="keywordflow">If</span> (.not.toggle) <span class="keywordflow">then</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;              <span class="keywordflow">DO</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                 <span class="keywordflow">if</span> (<a class="code" href="namespacehamiltonian.html#a77179b40953aaf13f002b7f4fc0b7456">projector</a>) <span class="keywordflow">then</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                    <span class="keyword">CALL </span>udvl(nf)%reset(<span class="stringliteral">&#39;l&#39;</span>,<a class="code" href="namespacehamiltonian.html#a3c2ccadb9ff957e46da6a1b7484755f1">wf_l</a>(nf)%P)</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                 <span class="keywordflow">else</span></div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                    <span class="keyword">CALL </span>udvl(nf)%reset(<span class="stringliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="keywordflow">                 endif</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="keywordflow">              ENDDO</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;              <span class="keywordflow">DO</span> nst = nstm-1,1,-1</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                 nt1 = stab_nt(nst+1)</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                 nt  = stab_nt(nst  )</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                 <span class="comment">!Write(6,*) NT1,NT, NST</span></div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                 <span class="keyword">CALL </span><a class="code" href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a>(nt1,nt, udvl)</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                 <span class="keywordflow">Do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                    udvst(nst, nf) = udvl(nf)</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="keywordflow">                 ENDDO</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="keywordflow">              ENDDO</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;              nt1 = stab_nt(1)</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;              <span class="keyword">CALL </span><a class="code" href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a>(nt1,0, udvl)</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="keywordflow">           Endif</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;           nvar  = 1</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;           phase = cmplx(1.d0,0.d0,kind(0.d0))</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;           <span class="keywordflow">do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;              <span class="keyword">CALL </span><a class="code" href="cgr1_8f90.html#ada6af176b0e7c9a3b0c19ebb798b3231">cgr</a>(z, nvar, gr(:,:,nf), udvr(nf),  udvl(nf))</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;              phase = phase*z</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="keywordflow">           Enddo</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;           <span class="keyword">call </span>op_phase(phase,<a class="code" href="namespacehamiltonian.html#a784fd999e79bf7eea97eb4b7695db65d">op_v</a>,<a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>,<a class="code" href="namespacehamiltonian.html#ac8b556cb31a51119226fa1b1afa87eb1">n_sun</a>)     </div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;           <span class="comment">!  First step: Each node sends to IRANK=0 its value nsigma_irank,</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;           <span class="comment">!  which is the node where its new Phase, GR, udvr, udvl, udvst is stored</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;           <span class="comment">!              This node then tells each node where to send its now old Phase, GR, udvr, udvl, udvst</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;           <span class="comment">!              Finally, the variables get submitted</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;           <span class="keywordflow">If</span> (irank == 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;              <span class="keywordflow">Do</span> i = 1,isize-1</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                 <span class="keyword">CALL </span>mpi_recv(nsigma_irank_temp , 1, mpi_integer, i, 0, mpi_comm_world,status,ierr)</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;                 <span class="keywordflow">If</span> ( nsigma_irank_temp == 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                    nsigma_old_irank = i</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                 <span class="keywordflow">else</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                    <span class="keyword">CALL </span>mpi_send(i , 1, mpi_integer, nsigma_irank_temp, 0, mpi_comm_world,ierr)</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="keywordflow">                 endif</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;<span class="keywordflow">              enddo</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;              <span class="keywordflow">If</span> ( nsigma_irank /= 0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                 <span class="keyword">CALL </span>mpi_send(0 , 1, mpi_integer, nsigma_irank, 0, mpi_comm_world,ierr)</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;           <span class="keywordflow">else</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;              <span class="keyword">CALL </span>mpi_send(nsigma_irank     , 1, mpi_integer, 0, 0, mpi_comm_world,ierr)</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;              <span class="keyword">CALL </span>mpi_recv(nsigma_old_irank , 1, mpi_integer, 0, 0, mpi_comm_world,status,ierr)</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        <span class="keywordflow">if</span> ( nsigma_irank /= irank ) <span class="keywordflow">then</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;           <span class="keyword">CALL </span>mpi_sendrecv_replace(phase, 1, mpi_complex16, nsigma_old_irank, 0, &amp;</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                    &amp;        nsigma_irank, 0, mpi_comm_world, status, ierr)</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;           n_gr = <span class="keyword">size</span>(gr,1)*<span class="keyword">size</span>(gr,2)*<span class="keyword">size</span>(gr,3)</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;           <span class="keyword">CALL </span>mpi_sendrecv_replace(gr, n_gr, mpi_complex16, nsigma_old_irank, 0, &amp;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                    &amp;        nsigma_irank, 0, mpi_comm_world, status, ierr)</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;           <span class="keywordflow">do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;              <span class="keyword">CALL </span>udvr(nf)%MPI_Sendrecv(nsigma_old_irank, 0, nsigma_irank, 0, status, ierr)</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="keywordflow">           enddo</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;           <span class="keywordflow">do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;              <span class="keyword">CALL </span>udvl(nf)%MPI_Sendrecv(nsigma_old_irank, 0, nsigma_irank, 0, status, ierr)</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="keywordflow">           enddo</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;           <span class="keywordflow">do</span> nst = 1, nstm</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;              <span class="keywordflow">do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                 <span class="keyword">CALL </span>udvst(nst, nf)%MPI_Sendrecv(nsigma_old_irank, 0, nsigma_irank, 0, status, ierr)</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="keywordflow">              enddo</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="keywordflow">           enddo</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;<span class="keywordflow">        endif</span>   </div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        </div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="keyword">Deallocate</span> ( nsigma_old )</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    <span class="keywordflow">if</span> (tempering_calc_det) <span class="keywordflow">then</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        <span class="keyword">Deallocate</span> ( det_vec_old, det_vec_new ) </div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        <span class="keyword">Deallocate</span> ( phase_det_new, phase_det_old )</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        <span class="keyword">Deallocate</span> ( list_partner, list_masters )</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;        </div><div class="ttc" id="wrapul_8f90_html_a6c424a08cbc18006fdfedb1a344ad245"><div class="ttname"><a href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a></div><div class="ttdeci">subroutine wrapul(NTAU1, NTAU, UDVL)</div><div class="ttdef"><b>Definition:</b> <a href="wrapul_8f90_source.html#l00033">wrapul.f90:33</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_af508f251b4965d458d35546984d69fb2"><div class="ttname"><a href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">hamiltonian::n_fl</a></div><div class="ttdeci">integer n_fl</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00139">Hamiltonian_Examples.f90:139</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a47e39398314b7c8194c8736008fc447c"><div class="ttname"><a href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">hamiltonian::nsigma</a></div><div class="ttdeci">class(fields), allocatable nsigma</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00137">Hamiltonian_Examples.f90:137</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a13c80692ce5836cdc65570c6c56b0801"><div class="ttname"><a href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">hamiltonian::ndim</a></div><div class="ttdeci">integer ndim</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00138">Hamiltonian_Examples.f90:138</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a3c2ccadb9ff957e46da6a1b7484755f1"><div class="ttname"><a href="namespacehamiltonian.html#a3c2ccadb9ff957e46da6a1b7484755f1">hamiltonian::wf_l</a></div><div class="ttdeci">type(wavefunction), dimension(:), allocatable wf_l</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00135">Hamiltonian_Examples.f90:135</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a77179b40953aaf13f002b7f4fc0b7456"><div class="ttname"><a href="namespacehamiltonian.html#a77179b40953aaf13f002b7f4fc0b7456">hamiltonian::projector</a></div><div class="ttdeci">logical projector</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00143">Hamiltonian_Examples.f90:143</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a784fd999e79bf7eea97eb4b7695db65d"><div class="ttname"><a href="namespacehamiltonian.html#a784fd999e79bf7eea97eb4b7695db65d">hamiltonian::op_v</a></div><div class="ttdeci">type(operator), dimension(:,:), allocatable op_v</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00133">Hamiltonian_Examples.f90:133</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_aef693c8b68751ed1e8ffc50b12890e02"><div class="ttname"><a href="namespacehamiltonian.html#aef693c8b68751ed1e8ffc50b12890e02">hamiltonian::group_comm</a></div><div class="ttdeci">integer group_comm</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00144">Hamiltonian_Examples.f90:144</a></div></div>
<div class="ttc" id="namespaceudv__state__mod_html"><div class="ttname"><a href="namespaceudv__state__mod.html">udv_state_mod</a></div><div class="ttdoc">Handles UDV decompositions. </div><div class="ttdef"><b>Definition:</b> <a href="udv__state_8F90_source.html#l00044">udv_state.F90:44</a></div></div>
<div class="ttc" id="namespacecontrol_html_a1a7790e18650d734f1fc8ccff8cc3fe0"><div class="ttname"><a href="namespacecontrol.html#a1a7790e18650d734f1fc8ccff8cc3fe0">control::control_upgrade_temp</a></div><div class="ttdeci">subroutine control_upgrade_temp(toggle)</div><div class="ttdef"><b>Definition:</b> <a href="control__mod_8f90_source.html#l00109">control_mod.f90:109</a></div></div>
<div class="ttc" id="namespacehamiltonian_html"><div class="ttname"><a href="namespacehamiltonian.html">hamiltonian</a></div><div class="ttdoc">This module defines the Hamiltonian and observables. Here, we have included a set of predefined Hamil...</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00116">Hamiltonian_Examples.f90:116</a></div></div>
<div class="ttc" id="namespaceudv__wrap__mod_html"><div class="ttname"><a href="namespaceudv__wrap__mod.html">udv_wrap_mod</a></div><div class="ttdoc">This module contains two version of the stabilization. </div><div class="ttdef"><b>Definition:</b> <a href="UDV__WRAP_8f90_source.html#l00043">UDV_WRAP.f90:43</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_ac8b556cb31a51119226fa1b1afa87eb1"><div class="ttname"><a href="namespacehamiltonian.html#ac8b556cb31a51119226fa1b1afa87eb1">hamiltonian::n_sun</a></div><div class="ttdeci">integer n_sun</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00140">Hamiltonian_Examples.f90:140</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_af627770a99fbe09e6cf52af735e251ba"><div class="ttname"><a href="namespacehamiltonian.html#af627770a99fbe09e6cf52af735e251ba">hamiltonian::delta_s0_global</a></div><div class="ttdeci">real(kind=kind(0.d0)) function delta_s0_global(Nsigma_old)</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00848">Hamiltonian_Examples.f90:848</a></div></div>
<div class="ttc" id="cgr1_8f90_html_ada6af176b0e7c9a3b0c19ebb798b3231"><div class="ttname"><a href="cgr1_8f90.html#ada6af176b0e7c9a3b0c19ebb798b3231">cgr</a></div><div class="ttdeci">subroutine cgr(PHASE, NVAR, GRUP, udvr, udvl)</div><div class="ttdoc">Computes GRUP = (1 + UR*DR*VR*VL*DL*UL)^-1 and PHASE = det(1 + UR*DR*VR*VL*DL*UL) / abs(det(1 + UR*DR...</div><div class="ttdef"><b>Definition:</b> <a href="cgr1_8f90_source.html#l00033">cgr1.f90:33</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae7afd49ef8db9c25c56cb64e18987b64"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae7afd49ef8db9c25c56cb64e18987b64">&#9670;&nbsp;</a></span>global_tempering_init_obs()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine global_mod::global_tempering_init_obs </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="Global__mod_8f90_source.html#l01000">1000</a> of file <a class="el" href="Global__mod_8f90_source.html">Global_mod.f90</a>.</p>

<p class="reference">References <a class="el" href="observables__mod_8f90_source.html#l00107">observables::obser_vec_init()</a>, and <a class="el" href="Global__mod_8f90_source.html#l00055">tempering_acceptance</a>.</p>

<p class="reference">Referenced by <a class="el" href="main_8f90_source.html#l00033">main()</a>.</p>
<div class="fragment"><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;        <span class="keyword">Call </span>obser_vec_init( tempering_acceptance )</div></div><!-- fragment -->
</div>
</div>
<a id="a65a05c74b02004eb46aa33f9c8464601"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a65a05c74b02004eb46aa33f9c8464601">&#9670;&nbsp;</a></span>global_tempering_obser()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine global_mod::global_tempering_obser </td>
          <td>(</td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>toggle</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="Global__mod_8f90_source.html#l01006">1006</a> of file <a class="el" href="Global__mod_8f90_source.html">Global_mod.f90</a>.</p>

<p class="reference">References <a class="el" href="Global__mod_8f90_source.html#l00055">tempering_acceptance</a>.</p>

<p class="reference">Referenced by <a class="el" href="Global__mod_8f90_source.html#l00071">exchange_step()</a>.</p>
<div class="fragment"><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;        <span class="keywordtype">Implicit none</span></div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;        <span class="keywordtype">Logical</span>, <span class="keywordtype">intent(in)</span> :: toggle</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;        tempering_acceptance%N         =  tempering_acceptance%N + 1</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;        tempering_acceptance%Ave_sign  =  tempering_acceptance%Ave_sign + 1.d0</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;        <span class="keywordflow">if</span> (toggle) tempering_acceptance%Obs_vec(1) = tempering_acceptance%Obs_vec(1) +  cmplx(1.d0,0.d0,kind(0.d0))</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;        </div></div><!-- fragment -->
</div>
</div>
<a id="abc55ba04905320858e15ecc7e9d20de4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abc55ba04905320858e15ecc7e9d20de4">&#9670;&nbsp;</a></span>global_tempering_pr()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine global_mod::global_tempering_pr </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="Global__mod_8f90_source.html#l01016">1016</a> of file <a class="el" href="Global__mod_8f90_source.html">Global_mod.f90</a>.</p>

<p class="reference">References <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00144">hamiltonian::group_comm</a>, <a class="el" href="observables__mod_8f90_source.html#l00229">observables::print_bin_vec()</a>, and <a class="el" href="Global__mod_8f90_source.html#l00055">tempering_acceptance</a>.</p>

<p class="reference">Referenced by <a class="el" href="main_8f90_source.html#l00033">main()</a>.</p>
<div class="fragment"><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;        <span class="keywordtype">Implicit none</span></div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;        <span class="keyword">Call  </span>print_bin_vec(tempering_acceptance,<a class="code" href="namespacehamiltonian.html#aef693c8b68751ed1e8ffc50b12890e02">group_comm</a>)</div><div class="ttc" id="namespacehamiltonian_html_aef693c8b68751ed1e8ffc50b12890e02"><div class="ttname"><a href="namespacehamiltonian.html#aef693c8b68751ed1e8ffc50b12890e02">hamiltonian::group_comm</a></div><div class="ttdeci">integer group_comm</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00144">Hamiltonian_Examples.f90:144</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a349bf6537abbd7eac41cade766f37574"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a349bf6537abbd7eac41cade766f37574">&#9670;&nbsp;</a></span>global_tempering_setup()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine global_mod::global_tempering_setup </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The following routine monitors the acceptance of tempering moves. </p>
<dl class="section author"><dt>Author</dt><dd>Fakher Assaad </dd></dl>

<p class="definition">Definition at line <a class="el" href="Global__mod_8f90_source.html#l00990">990</a> of file <a class="el" href="Global__mod_8f90_source.html">Global_mod.f90</a>.</p>

<p class="reference">References <a class="el" href="observables__mod_8f90_source.html#l00097">observables::obser_vec_make()</a>, and <a class="el" href="Global__mod_8f90_source.html#l00055">tempering_acceptance</a>.</p>

<p class="reference">Referenced by <a class="el" href="main_8f90_source.html#l00033">main()</a>.</p>
<div class="fragment"><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;        <span class="keywordtype">Integer</span>    ::   N</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;        <span class="keywordtype">Character (len=64)</span> ::  Filename</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;        n = 1</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;        filename = <span class="stringliteral">&quot;Acc_Temp&quot;</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;        <span class="keyword">Call </span>obser_vec_make(tempering_acceptance,n,filename)</div></div><!-- fragment -->
</div>
</div>
<a id="a4a02e45603e49769d5d2757c82508331"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4a02e45603e49769d5d2757c82508331">&#9670;&nbsp;</a></span>global_updates()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine global_mod::global_updates </td>
          <td>(</td>
          <td class="paramtype">complex (kind=kind(0.d0)), intent(inout)&#160;</td>
          <td class="paramname"><em>Phase</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">complex (kind=kind(0.d0)), dimension(:,:,:), intent(inout), allocatable&#160;</td>
          <td class="paramname"><em>GR</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">class (udv_state), dimension(:), intent(inout), allocatable&#160;</td>
          <td class="paramname"><em>udvr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">class (udv_state), dimension(:), intent(inout), allocatable&#160;</td>
          <td class="paramname"><em>udvl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(:), intent(in), allocatable&#160;</td>
          <td class="paramname"><em>Stab_nt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">class(udv_state), dimension(:,:), intent(inout), allocatable&#160;</td>
          <td class="paramname"><em>udvst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>N_Global</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Carries out N_global global updates as defeined in the Global_move routine of the Hamiltonian module. </p>
<dl class="section author"><dt>Author</dt><dd>The ALF Project contributors</dd></dl>
<p>On entry and on exit the left storage is full, the Green function is on time slice 0 and the phase is set. The same holds on exit but with updated quantities.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">Phase</td><td>Complex <pre class="fragment">  Is updated upon acceptance</pre> </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">udvl,udvr</td><td>Class(UDV_State) <pre class="fragment">  On entry udvl contains the last udv decomposition such that G=(1 + VL*DL*UL^{dag})^{-1}
  udvr  is used as working space</pre> </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">GR</td><td>Complex <pre class="fragment">  Green function. Is updated upon acceptance.</pre> </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">udvst</td><td>Class(UDV_State) <pre class="fragment">  Storage. Is updated with left propagation upon acceptance</pre> </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">Stab_nt</td><td>Integer <pre class="fragment">  List of time slices for stabilization.</pre> </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">N_Global</td><td>Integer <pre class="fragment">  Number of global moves that will be caried out</pre> </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="Global__mod_8f90_source.html#l00494">494</a> of file <a class="el" href="Global__mod_8f90_source.html">Global_mod.f90</a>.</p>

<p class="reference">References <a class="el" href="cgr1_8f90_source.html#l00033">cgr()</a>, <a class="el" href="Global__mod_8f90_source.html#l00794">compute_fermion_det()</a>, <a class="el" href="Global__mod_8f90_source.html#l00699">compute_ratio_global()</a>, <a class="el" href="control__mod_8f90_source.html#l00165">control::control_precisionp_glob()</a>, <a class="el" href="control__mod_8f90_source.html#l00116">control::control_upgrade_glob()</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00820">hamiltonian::global_move()</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00139">hamiltonian::n_fl</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00140">hamiltonian::n_sun</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00138">hamiltonian::ndim</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00137">hamiltonian::nsigma</a>, <a class="el" href="Operator_8f90_source.html#l00151">operator_mod::op_phase()</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00133">hamiltonian::op_v</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00143">hamiltonian::projector</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00135">hamiltonian::wf_l</a>, <a class="el" href="Hamiltonian__Examples_8f90_source.html#l00136">hamiltonian::wf_r</a>, and <a class="el" href="wrapul_8f90_source.html#l00033">wrapul()</a>.</p>

<p class="reference">Referenced by <a class="el" href="main_8f90_source.html#l00033">main()</a>.</p>
<div class="fragment"><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        </div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        <span class="keywordtype">Use </span><a class="code" href="namespaceudv__state__mod.html">udv_state_mod</a></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        <span class="keywordtype">Implicit none</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        </div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;        <span class="keyword">Interface</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="keyword">           SUBROUTINE </span><a class="code" href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a>(NTAU1, NTAU, udvl)</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;             <span class="keywordtype">Use </span><a class="code" href="namespacehamiltonian.html">hamiltonian</a></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;             <span class="keywordtype">Use </span><a class="code" href="namespaceudv__state__mod.html">udv_state_mod</a></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;             <span class="keywordtype">Implicit none</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;             <span class="keywordtype">CLASS</span>(UDV_State), <span class="keywordtype">intent(inout)</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">dimension(:)</span> :: udvl</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;             <span class="keywordtype">Integer</span> :: NTAU1, NTAU</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="keyword">           END SUBROUTINE </span><a class="code" href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="keyword">           SUBROUTINE </span><a class="code" href="cgr1_8f90.html#ada6af176b0e7c9a3b0c19ebb798b3231">cgr</a>(PHASE,NVAR, GRUP, udvr, udvl)</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;             <span class="keywordtype">Use </span><a class="code" href="namespaceudv__wrap__mod.html">udv_wrap_mod</a></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;             <span class="keywordtype">Use </span><a class="code" href="namespaceudv__state__mod.html">udv_state_mod</a></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;             <span class="keywordtype">Implicit None</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;             <span class="keywordtype">CLASS</span>(UDV_State), <span class="keywordtype">INTENT(IN)</span> :: udvl, udvr</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;             <span class="keywordtype">COMPLEX(Kind=Kind(0.d0))</span>, <span class="keywordtype">Dimension(:,:)</span>, <span class="keywordtype">Intent(Inout)</span> :: GRUP</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;             <span class="keywordtype">COMPLEX(Kind=Kind(0.d0))</span> :: PHASE</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;             <span class="keywordtype">INTEGER</span>         :: NVAR</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="keyword">           END SUBROUTINE </span><a class="code" href="cgr1_8f90.html#ada6af176b0e7c9a3b0c19ebb798b3231">cgr</a></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="keyword">        end Interface</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;        </div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        <span class="comment">!  Arguments</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;        <span class="keywordtype">COMPLEX (Kind=Kind(0.d0))</span>,                                <span class="keywordtype">INTENT(INOUT)</span> :: Phase</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;        class(<a class="code" href="structudv__state__mod_1_1udv__state.html">udv_state</a>), <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">ALLOCATABLE</span>,           <span class="keywordtype">INTENT(INOUT)</span> :: udvl, udvr</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        <span class="keywordtype">COMPLEX (Kind=Kind(0.d0))</span>, <span class="keywordtype">Dimension(:,:,:)</span>,  <span class="keywordtype">allocatable</span>,<span class="keywordtype">INTENT(INOUT)</span> :: GR</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        <span class="keywordtype">CLASS</span>(UDV_State), <span class="keywordtype">Dimension(:,:)</span>, <span class="keywordtype">ALLOCATABLE</span>,            <span class="keywordtype">INTENT(INOUT)</span> :: udvst</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        <span class="keywordtype">INTEGER</span>, <span class="keywordtype">dimension(:)</span>,   <span class="keywordtype">allocatable</span>,                     <span class="keywordtype">INTENT(IN)</span>    :: Stab_nt</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        <span class="keywordtype">Integer</span>,                                                  <span class="keywordtype">INTENT(IN)</span>    :: N_Global</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        </div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        </div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;        <span class="comment">!  Local variables.</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        <span class="keywordtype">Integer</span> :: NST, NSTM, NF, NT, NT1, NVAR,N, N1,N2, I, NC, N_part,j</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        <span class="keywordtype">Real    (Kind=Kind(0.d0))</span> :: T0_Proposal_ratio, Weight</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        <span class="keywordtype">Complex (Kind=Kind(0.d0))</span> :: Z_ONE = cmplx(1.d0, 0.d0, kind(0.d0)), z, ratiotot, phase_old, phase_new</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        <span class="keywordtype">Complex (Kind=Kind(0.d0))</span>, <span class="keywordtype">allocatable</span> :: Det_vec_test(:,:), Phase_Det_new(:), Phase_Det_old(:)</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        <span class="keywordtype">Real    (Kind=Kind(0.d0))</span>, <span class="keywordtype">allocatable</span> :: Det_vec_old(:,:), Det_vec_new(:,:)</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        class(<a class="code" href="structfields__mod_1_1fields.html">fields</a>), <span class="keywordtype">allocatable</span> :: nsigma_old</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        <span class="keywordtype">Complex (Kind=Kind(0.d0))</span> :: Ratio(2)</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        <span class="keywordtype">Logical</span> :: TOGGLE, L_Test</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        <span class="keywordtype">Real    (Kind=Kind(0.d0))</span> :: size_clust</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        <span class="keywordtype">Real    (Kind=Kind(0.d0))</span> :: ratio_2_test</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <span class="keywordtype">Character (Len=64)</span>  :: storage </div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        </div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        </div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        </div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        n1 = <span class="keyword">size</span>(<a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>%f,1)</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        n2 = <span class="keyword">size</span>(<a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>%f,2)</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        nstm = <span class="keyword">Size</span>(udvst, 1)</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        <span class="keyword">allocate</span>(nsigma_old)</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        <span class="keyword">call </span>nsigma_old%make(n1, n2)</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        <span class="keyword">Allocate</span> ( det_vec_old(<a class="code" href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">ndim</a>,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a>), det_vec_new(<a class="code" href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">ndim</a>,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a>), det_vec_test(<a class="code" href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">ndim</a>,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a>) ) </div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        <span class="keyword">Allocate</span> ( phase_det_new(<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a>), phase_det_old(<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a>) )</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        </div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        l_test = .false.</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        <span class="comment">! Set old weight. </span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        storage = <span class="stringliteral">&quot;Full&quot;</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        <span class="keyword">Call </span>compute_fermion_det(phase_det_old,det_vec_old, udvl, udvst, stab_nt, storage)</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;        </div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        <span class="keywordflow">If</span> (l_test) <span class="keywordflow">then</span> </div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;           <span class="comment">! Testing    </span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;           <span class="keywordflow">Do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;              <span class="keywordflow">if</span> (<a class="code" href="namespacehamiltonian.html#a77179b40953aaf13f002b7f4fc0b7456">projector</a>) <span class="keywordflow">then</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                 <span class="keyword">CALL </span>udvr(nf)%reset(<span class="stringliteral">&#39;r&#39;</span>,<a class="code" href="namespacehamiltonian.html#adbb663a56d63496d9b9f883e84d527ed">wf_r</a>(nf)%P)</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                 <span class="keyword">CALL </span>udvr(nf)%reset(<span class="stringliteral">&#39;r&#39;</span>)</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="keywordflow">           Enddo</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;           nvar = 1</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;           phase = cmplx(1.d0,0.d0,kind(0.d0))</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;           <span class="keywordflow">do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;              <span class="keyword">CALL </span><a class="code" href="cgr1_8f90.html#ada6af176b0e7c9a3b0c19ebb798b3231">cgr</a>(z, nvar, gr(:,:,nf), udvr(nf), udvl(nf))</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;              phase = phase*z</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;<span class="keywordflow">           Enddo</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;           <span class="keyword">call </span>op_phase(phase,<a class="code" href="namespacehamiltonian.html#a784fd999e79bf7eea97eb4b7695db65d">op_v</a>,<a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>,<a class="code" href="namespacehamiltonian.html#ac8b556cb31a51119226fa1b1afa87eb1">n_sun</a>) </div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;           <span class="keywordflow">Do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;              <span class="keyword">Call </span>det_c_lu(gr(:,:,nf),det_vec_test(:,nf),<a class="code" href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">ndim</a>)</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;              z = phase_det_old(nf)</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;              ratio_2_test=0.d0</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;              <span class="keywordflow">DO</span> i = 1,<a class="code" href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">ndim</a></div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                 z = z*det_vec_test(i,nf)/abs(det_vec_test(i,nf))</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                 ratio_2_test=ratio_2_test+log(abs(det_vec_test(i,nf)))+det_vec_old(i,nf)</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;<span class="keywordflow">              Enddo</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;              z=z*cmplx(exp(ratio_2_test),0.d0,kind(0.d0))</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;              <span class="keyword">Write</span>(6,*) <span class="stringliteral">&#39;Testing weight: &#39;</span>, z</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;              <span class="keywordflow">if</span>(abs(ratio_2_test)&gt;650) <span class="keyword">write</span>(6,*) <span class="stringliteral">&quot;Weight is about to reach double underflow!&quot;</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="keywordflow">           Enddo</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="keywordflow">        Endif</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        </div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        <span class="comment">! Store old configuration</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        nsigma_old%f = <a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>%f</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;        nsigma_old%t = <a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>%t</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;        <span class="comment">! Phase_old, Phase_det_old and Det_vec_old  are all set. </span></div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        nc = 0</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        <span class="keywordflow">Do</span> n = 1,n_global</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;           <span class="comment">! Draw a new spin configuration. This is provided by the user in the Hamiltonian module</span></div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;           <span class="comment">! Note that nsigma is a variable in the module Hamiltonian</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;           <span class="keyword">Call </span><a class="code" href="namespacehamiltonian.html#a0648841005a77912a7f2d1afd0ae26fe">global_move</a>(t0_proposal_ratio,nsigma_old,size_clust)</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;           <span class="keywordflow">If</span> (t0_proposal_ratio &gt; 1.d-24) <span class="keywordflow">then</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;              nc = nc + 1</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;              <span class="comment">! Compute the new Green function</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;              storage = <span class="stringliteral">&quot;Empty&quot;</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;              <span class="keyword">Call </span>compute_fermion_det(phase_det_new,det_vec_new, udvl, udvst, stab_nt, storage)</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;              ratiotot = compute_ratio_global(phase_det_old, phase_det_new, &amp;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                   &amp;                          det_vec_old, det_vec_new, nsigma_old, t0_proposal_ratio, ratio) </div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;              </div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;              <span class="comment">!Write(6,*) &#39;Ratio_global: &#39;, Ratiotot</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;              </div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;              weight = abs(  <span class="keywordtype">real</span>(Phase_old * Ratiotot, kind=kind(0.d0))/<span class="keywordtype">real(Phase_old,kind=Kind(0.d0))</span> )</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;              </div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;              z = phase_old * ratiotot/abs(ratiotot)</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;              <span class="keyword">Call </span><a class="code" href="namespacecontrol.html#adfb546f46f7cba48d6607838f185462b">control_precisionp_glob</a>(z,phase_new)</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;              <span class="comment">!Write(6,*) Z, Phase_new</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;              </div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;              </div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;              toggle = .false. </div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;              <span class="keywordflow">if</span> ( weight &gt; ranf_wrap() )  <span class="keywordflow">Then</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                 toggle = .true.</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;                 phase_old     = phase_new</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                 phase_det_old = phase_det_new</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                 nsigma_old%t    = <a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>%t</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                 nsigma_old%f    = <a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>%f</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                 det_vec_old     = det_vec_new</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                 <a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>%t = nsigma_old%t</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                 <a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>%f = nsigma_old%f</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;              <span class="keyword">Call </span><a class="code" href="namespacecontrol.html#a1a4ad50fb09552b0fe0b24e67b9d6da5">control_upgrade_glob</a>(toggle,size_clust)</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="keywordflow">           endif</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="keywordflow">        Enddo</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        </div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        <span class="keywordflow">If</span> (nc &gt; 0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;           <span class="keywordflow">If</span> (.not.toggle) <span class="keywordflow">then</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;              <span class="keywordflow">DO</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="namespacehamiltonian.html#a77179b40953aaf13f002b7f4fc0b7456">projector</a>) <span class="keywordflow">then</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                  <span class="keyword">CALL </span>udvl(nf)%reset(<span class="stringliteral">&#39;l&#39;</span>,<a class="code" href="namespacehamiltonian.html#a3c2ccadb9ff957e46da6a1b7484755f1">wf_l</a>(nf)%P)</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                  <span class="keyword">CALL </span>udvl(nf)%reset(<span class="stringliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="keywordflow">                endif</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="keywordflow">              ENDDO</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;              <span class="keywordflow">DO</span> nst = nstm-1,1,-1</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                 nt1 = stab_nt(nst+1)</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                 nt  = stab_nt(nst  )</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                 <span class="comment">!Write(6,*) NT1,NT, NST</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                 <span class="keyword">CALL </span><a class="code" href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a>(nt1,nt, udvl)</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                 <span class="keywordflow">Do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                    udvst(nst, nf) = udvl(nf)</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="keywordflow">                 ENDDO</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="keywordflow">              ENDDO</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;              nt1 = stab_nt(1)</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;              <span class="keyword">CALL </span><a class="code" href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a>(nt1,0, udvl)</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;<span class="keywordflow">           Endif</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;           <span class="comment">!Compute the Green functions so as to provide correct starting point for the sequential updates.</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;           nvar  = 1</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;           phase = cmplx(1.d0,0.d0,kind(0.d0))</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;           <span class="keywordflow">do</span> nf = 1,<a class="code" href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">n_fl</a></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;              <span class="keyword">CALL </span><a class="code" href="cgr1_8f90.html#ada6af176b0e7c9a3b0c19ebb798b3231">cgr</a>(z, nvar, gr(:,:,nf), udvr(nf), udvl(nf))</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;              phase = phase*z</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;<span class="keywordflow">           Enddo</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;           <span class="keyword">call </span>op_phase(phase,<a class="code" href="namespacehamiltonian.html#a784fd999e79bf7eea97eb4b7695db65d">op_v</a>,<a class="code" href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">nsigma</a>,<a class="code" href="namespacehamiltonian.html#ac8b556cb31a51119226fa1b1afa87eb1">n_sun</a>) </div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        </div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        </div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;        <span class="keyword">call </span>nsigma_old%clear</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        <span class="keyword">deallocate</span>(nsigma_old)</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;        <span class="keyword">Deallocate</span> ( det_vec_old  , det_vec_new, det_vec_test  ) </div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        <span class="keyword">Deallocate</span> ( phase_det_new, phase_det_old )</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;        </div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;        </div><div class="ttc" id="namespacehamiltonian_html_a0648841005a77912a7f2d1afd0ae26fe"><div class="ttname"><a href="namespacehamiltonian.html#a0648841005a77912a7f2d1afd0ae26fe">hamiltonian::global_move</a></div><div class="ttdeci">subroutine global_move(T0_Proposal_ratio, nsigma_old, size_clust)</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00820">Hamiltonian_Examples.f90:820</a></div></div>
<div class="ttc" id="structfields__mod_1_1fields_html"><div class="ttname"><a href="structfields__mod_1_1fields.html">fields_mod::fields</a></div><div class="ttdef"><b>Definition:</b> <a href="Fields__mod_8f90_source.html#l00065">Fields_mod.f90:65</a></div></div>
<div class="ttc" id="namespacecontrol_html_a1a4ad50fb09552b0fe0b24e67b9d6da5"><div class="ttname"><a href="namespacecontrol.html#a1a4ad50fb09552b0fe0b24e67b9d6da5">control::control_upgrade_glob</a></div><div class="ttdeci">subroutine control_upgrade_glob(toggle, size_clust)</div><div class="ttdef"><b>Definition:</b> <a href="control__mod_8f90_source.html#l00116">control_mod.f90:116</a></div></div>
<div class="ttc" id="wrapul_8f90_html_a6c424a08cbc18006fdfedb1a344ad245"><div class="ttname"><a href="wrapul_8f90.html#a6c424a08cbc18006fdfedb1a344ad245">wrapul</a></div><div class="ttdeci">subroutine wrapul(NTAU1, NTAU, UDVL)</div><div class="ttdef"><b>Definition:</b> <a href="wrapul_8f90_source.html#l00033">wrapul.f90:33</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_af508f251b4965d458d35546984d69fb2"><div class="ttname"><a href="namespacehamiltonian.html#af508f251b4965d458d35546984d69fb2">hamiltonian::n_fl</a></div><div class="ttdeci">integer n_fl</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00139">Hamiltonian_Examples.f90:139</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a47e39398314b7c8194c8736008fc447c"><div class="ttname"><a href="namespacehamiltonian.html#a47e39398314b7c8194c8736008fc447c">hamiltonian::nsigma</a></div><div class="ttdeci">class(fields), allocatable nsigma</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00137">Hamiltonian_Examples.f90:137</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a13c80692ce5836cdc65570c6c56b0801"><div class="ttname"><a href="namespacehamiltonian.html#a13c80692ce5836cdc65570c6c56b0801">hamiltonian::ndim</a></div><div class="ttdeci">integer ndim</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00138">Hamiltonian_Examples.f90:138</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a3c2ccadb9ff957e46da6a1b7484755f1"><div class="ttname"><a href="namespacehamiltonian.html#a3c2ccadb9ff957e46da6a1b7484755f1">hamiltonian::wf_l</a></div><div class="ttdeci">type(wavefunction), dimension(:), allocatable wf_l</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00135">Hamiltonian_Examples.f90:135</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a77179b40953aaf13f002b7f4fc0b7456"><div class="ttname"><a href="namespacehamiltonian.html#a77179b40953aaf13f002b7f4fc0b7456">hamiltonian::projector</a></div><div class="ttdeci">logical projector</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00143">Hamiltonian_Examples.f90:143</a></div></div>
<div class="ttc" id="structudv__state__mod_1_1udv__state_html"><div class="ttname"><a href="structudv__state__mod_1_1udv__state.html">udv_state_mod::udv_state</a></div><div class="ttdoc">Handles UDV decompositions. </div><div class="ttdef"><b>Definition:</b> <a href="udv__state_8F90_source.html#l00082">udv_state.F90:82</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_a784fd999e79bf7eea97eb4b7695db65d"><div class="ttname"><a href="namespacehamiltonian.html#a784fd999e79bf7eea97eb4b7695db65d">hamiltonian::op_v</a></div><div class="ttdeci">type(operator), dimension(:,:), allocatable op_v</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00133">Hamiltonian_Examples.f90:133</a></div></div>
<div class="ttc" id="namespacecontrol_html_adfb546f46f7cba48d6607838f185462b"><div class="ttname"><a href="namespacecontrol.html#adfb546f46f7cba48d6607838f185462b">control::control_precisionp_glob</a></div><div class="ttdeci">subroutine control_precisionp_glob(Z, Z1)</div><div class="ttdef"><b>Definition:</b> <a href="control__mod_8f90_source.html#l00165">control_mod.f90:165</a></div></div>
<div class="ttc" id="namespaceudv__state__mod_html"><div class="ttname"><a href="namespaceudv__state__mod.html">udv_state_mod</a></div><div class="ttdoc">Handles UDV decompositions. </div><div class="ttdef"><b>Definition:</b> <a href="udv__state_8F90_source.html#l00044">udv_state.F90:44</a></div></div>
<div class="ttc" id="namespacehamiltonian_html"><div class="ttname"><a href="namespacehamiltonian.html">hamiltonian</a></div><div class="ttdoc">This module defines the Hamiltonian and observables. Here, we have included a set of predefined Hamil...</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00116">Hamiltonian_Examples.f90:116</a></div></div>
<div class="ttc" id="namespaceudv__wrap__mod_html"><div class="ttname"><a href="namespaceudv__wrap__mod.html">udv_wrap_mod</a></div><div class="ttdoc">This module contains two version of the stabilization. </div><div class="ttdef"><b>Definition:</b> <a href="UDV__WRAP_8f90_source.html#l00043">UDV_WRAP.f90:43</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_ac8b556cb31a51119226fa1b1afa87eb1"><div class="ttname"><a href="namespacehamiltonian.html#ac8b556cb31a51119226fa1b1afa87eb1">hamiltonian::n_sun</a></div><div class="ttdeci">integer n_sun</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00140">Hamiltonian_Examples.f90:140</a></div></div>
<div class="ttc" id="namespacehamiltonian_html_adbb663a56d63496d9b9f883e84d527ed"><div class="ttname"><a href="namespacehamiltonian.html#adbb663a56d63496d9b9f883e84d527ed">hamiltonian::wf_r</a></div><div class="ttdeci">type(wavefunction), dimension(:), allocatable wf_r</div><div class="ttdef"><b>Definition:</b> <a href="Hamiltonian__Examples_8f90_source.html#l00136">Hamiltonian_Examples.f90:136</a></div></div>
<div class="ttc" id="cgr1_8f90_html_ada6af176b0e7c9a3b0c19ebb798b3231"><div class="ttname"><a href="cgr1_8f90.html#ada6af176b0e7c9a3b0c19ebb798b3231">cgr</a></div><div class="ttdeci">subroutine cgr(PHASE, NVAR, GRUP, udvr, udvl)</div><div class="ttdoc">Computes GRUP = (1 + UR*DR*VR*VL*DL*UL)^-1 and PHASE = det(1 + UR*DR*VR*VL*DL*UL) / abs(det(1 + UR*DR...</div><div class="ttdef"><b>Definition:</b> <a href="cgr1_8f90_source.html#l00033">cgr1.f90:33</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="acc8784f6dafc9c0259291e16b16ed6d4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acc8784f6dafc9c0259291e16b16ed6d4">&#9670;&nbsp;</a></span>npbc_tempering()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">integer function global_mod::npbc_tempering </td>
          <td>(</td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>Isize</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Periodic boundary conditions required to defined master and slave for the <br />
<br />
 tempering. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">isize</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section author"><dt>Author</dt><dd>Fakher Assaad</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">n</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section author"><dt>Author</dt><dd>Fakher Assaad</dd></dl>
<p>Periodic boundary conditions required to defined master and slave for the <br />
 tempering </p>

<p class="definition">Definition at line <a class="el" href="Global__mod_8f90_source.html#l00963">963</a> of file <a class="el" href="Global__mod_8f90_source.html">Global_mod.f90</a>.</p>

<p class="reference">Referenced by <a class="el" href="Global__mod_8f90_source.html#l00071">exchange_step()</a>.</p>
<div class="fragment"><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;<span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;<span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        <span class="keywordtype">implicit none</span></div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;        <span class="keywordtype">Integer</span>,  <span class="keywordtype">INTENT(IN)</span>   :: Isize,n</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;        </div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        npbc_tempering = n</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        <span class="keywordflow">if</span> (  npbc_tempering &lt; 0       ) npbc_tempering = npbc_tempering +  isize</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        <span class="keywordflow">if</span> (  npbc_tempering &gt; isize -1) npbc_tempering = npbc_tempering -  isize</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;        </div></div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a5fffa8bf277527c37a705dd5d13e04c3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5fffa8bf277527c37a705dd5d13e04c3">&#9670;&nbsp;</a></span>tempering_acceptance</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">type (obser_vec ), private global_mod::tempering_acceptance</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="Global__mod_8f90_source.html#l00055">55</a> of file <a class="el" href="Global__mod_8f90_source.html">Global_mod.f90</a>.</p>

<p class="reference">Referenced by <a class="el" href="Global__mod_8f90_source.html#l01000">global_tempering_init_obs()</a>, <a class="el" href="Global__mod_8f90_source.html#l01006">global_tempering_obser()</a>, <a class="el" href="Global__mod_8f90_source.html#l01016">global_tempering_pr()</a>, and <a class="el" href="Global__mod_8f90_source.html#l00990">global_tempering_setup()</a>.</p>
<div class="fragment"><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;      type(obser_vec ),  <span class="keywordtype">private</span>  ::   tempering_acceptance</div></div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Aug 7 2018 05:09:09 for ALF by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
