!-------------------------------------------------------------------
!> @author
!> ALF-project
!
!>  @brief
!>  Let  \tilde{f}^{\dagger}_{i,\sigma}  be the cotunnling  composite fermion operator  (see notes).  This routine computes
!>  \sum_{sigma} < \tilde{f}^{\dagger}_{i,\sigma}(tau)  \tilde{f}_{j,\sigma}(0)>
!>
!>  If N_FL = 1 then N_SUN can take any value.
!>  If N_FL = 2 then N_SUN = 1 
!--------------------------------------------------------------------
      Complex (Kind=Kind(0.d0)) function Predefined_Obs_Cotunneling(I_c, I_f, J_c, J_f,  GT0,G0T,G00,GTT, N_SUN, N_FL) 

        Integer,              Intent(In)      :: N_SUN, I_c,I_f, J_c, J_f, N_FL
        Complex (Kind=Kind(0.d0)), Intent(In) :: GT0(:,:,:), G0T(:,:,:), G00(:,:,:), GTT(:,:,:)

        
        ! Local
        Integer ::  ns
        Complex  (Kind=Kind(0.d0))   ::  G(3,3), G1(3,3,2), Z

        Predefined_Obs_Cotunneling  = cmplx(0.d0,0.d0,kind(0.d0))
        If (N_FL == 1)  then
           G(1,1)  = 1.d0 - GTT(I_f,I_f,1)
           G(1,2)  = -G0T(J_c,I_f,1)
           G(1,3)  = -G0T(J_f,I_f,1)
           G(2,1)  = -GTT(I_f,I_c,1)
           G(2,2)  = -G0T(J_c,I_c,1)
           G(2,3)  = -G0T(J_f,I_c,1)
           G(3,1)  = -GT0(I_f,J_f,1)
           G(3,2)  = -G00(J_c,J_f,1)
           G(3,3)  = 1.d0 - G00(J_f,J_f,1)
           select Case(N_SUN)
           case (2)
              Z =  (32.0*(1.*G(1,1)*G(2,3)*G(3,2) + 1.*G(1,2)*G(2,1)*G(3,3))  + &
                   &    2.0*((-25.*G(1,3)*G(2,2) - 20.*G(1,2)*G(2,3))*G(3,1)  + &
                   &       (-48.*G(1,3)*G(2,1) - 95.*G(1,1)*G(2,3))*G(3,2)    + &
                   &       (-84.*G(1,2)*G(2,1) - 21.5*G(1,1)*G(2,2))*G(3,3))  + &
                   &    8.0*(2*(-4.*G(1,3)*G(2,1) - 10.*G(1,1)*G(2,3))*G(3,2) + &
                   &       (-19.*G(1,2)*G(2,1) - 1.5*G(1,1)*G(2,2))*G(3,3))   + &
                   &    2.0*(9.*(1.*G(1,3)*G(2,2) + 1.*G(1,2)*G(2,3))*G(3,1)  + &
                   &       (9.*G(1,3)*G(2,1) + 21.*G(1,1)*G(2,3))*G(3,2)      + &
                   &       (18.*G(1,2)*G(2,1) + 7.5*G(1,1)*G(2,2))*G(3,3))    + &
                   &    4.0*((5.*G(1,3)*G(2,2) + 4.*G(1,2)*G(2,3))*G(3,1)     + &
                   &       (40.*G(1,3)*G(2,1) + 69.*G(1,1)*G(2,3))*G(3,2)     + &
                   &       (63.*G(1,2)*G(2,1) + 10.*G(1,1)*G(2,2))*G(3,3)))/4.
           case (4)
              Z =  (1024.*(1.*G(1,1)*G(2,3)*G(3,2) + 1.*G(1,2)*G(2,1)*G(3,3))   + &
                   &    4.*((-153.*G(1,3)*G(2,2) - 72.*G(1,2)*G(2,3))*G(3,1)    + &
                   &       (-280.*G(1,3)*G(2,1) - 517.*G(1,1)*G(2,3))*G(3,2)    + &
                   &       (-459.*G(1,2)*G(2,1) - 70.5*G(1,1)*G(2,2))*G(3,3))   + &
                   &    64.*(4.*(-8.*G(1,3)*G(2,1) - 14.*G(1,1)*G(2,3))*G(3,2)  + &
                   &       (-54.*G(1,2)*G(2,1) - 1.5*G(1,1)*G(2,2))*G(3,3))     + &
                   &    16.*((17.*G(1,3)*G(2,2) + 8.*G(1,2)*G(2,3))*G(3,1)      + &
                   &       (248.*G(1,3)*G(2,1) + 273.*G(1,1)*G(2,3))*G(3,2)     + &
                   &       (253.*G(1,2)*G(2,1) + 18.*G(1,1)*G(2,2))*G(3,3))     + &
                   &    4.*(25.*(1.*G(1,3)*G(2,2) + 1.*G(1,2)*G(2,3))*G(3,1)    + &
                   &       (25.*G(1,3)*G(2,1) + 65.*G(1,1)*G(2,3))*G(3,2)       + &
                   &       (55.*G(1,2)*G(2,1) + 22.5*G(1,1)*G(2,2))*G(3,3)))/16.
           case (6)
              Z = (7776.*(1.*G(1,1)*G(2,3)*G(3,2) + 1.*G(1,2)*G(2,1)*G(3,3))    + &
                   &    6.*((-481.*G(1,3)*G(2,2) - 156.*G(1,2)*G(2,3))*G(3,1)   + &
                   &       (-840.*G(1,3)*G(2,1) - 1507.*G(1,1)*G(2,3))*G(3,2)   + &
                   &       (-1342.*G(1,2)*G(2,1) - 147.5*G(1,1)*G(2,2))*G(3,3)) + &
                   &    216.*(6*(-12.*G(1,3)*G(2,1) - 18.*G(1,1)*G(2,3))*G(3,2) + &
                   &       (-105.*G(1,2)*G(2,1) - 1.5*G(1,1)*G(2,2))*G(3,3))    + &
                   &    36.*((37.*G(1,3)*G(2,2) + 12.*G(1,2)*G(2,3))*G(3,1)     + &
                   &       (768.*G(1,3)*G(2,1) + 661.*G(1,1)*G(2,3))*G(3,2)     + &
                   &       (619.*G(1,2)*G(2,1) + 26.*G(1,1)*G(2,2))*G(3,3))     + &
                   &    6.*(49.*(1.*G(1,3)*G(2,2) + 1.*G(1,2)*G(2,3))*G(3,1)    + &
                   &       (49.*G(1,3)*G(2,1) + 133.*G(1,1)*G(2,3))*G(3,2)      + &
                   &       (112.*G(1,2)*G(2,1) + 45.5*G(1,1)*G(2,2))*G(3,3)))/36.
           case (8)
              Z = (32768*(1.*G(1,1)*G(2,3)*G(3,2) + 1.*G(1,2)*G(2,1)*G(3,3))    + &
                   &    8*((-1105.*G(1,3)*G(2,2) - 272.*G(1,2)*G(2,3))*G(3,1)   + &
                   &       (-1872.*G(1,3)*G(2,1) - 3305.*G(1,1)*G(2,3))*G(3,2)  + &
                   &       (-2949.*G(1,2)*G(2,1) - 252.5*G(1,1)*G(2,2))*G(3,3)) + &
                   &    512*(8*(-16.*G(1,3)*G(2,1) - 22.*G(1,1)*G(2,3))*G(3,2)  + &
                   &       (-172.*G(1,2)*G(2,1) - 1.5*G(1,1)*G(2,2))*G(3,3))    + &
                   &    64*((65.*G(1,3)*G(2,2) + 16.*G(1,2)*G(2,3))*G(3,1)      + &
                   &       (1744.*G(1,3)*G(2,1) + 1281.*G(1,1)*G(2,3))*G(3,2)   + &
                   &       (1209.*G(1,2)*G(2,1) + 34.*G(1,1)*G(2,2))*G(3,3))    + &
                   &    8*(81.*(1.*G(1,3)*G(2,2) + 1.*G(1,2)*G(2,3))*G(3,1)     + &
                   &       (81.*G(1,3)*G(2,1) + 225.*G(1,1)*G(2,3))*G(3,2)      + &
                   &       (189.*G(1,2)*G(2,1) + 76.5*G(1,1)*G(2,2))*G(3,3)))/64. 
           case default
              Write(error_unit,*) 'Cotunneling, N_SUN=', N_SUN, 'is not yet implemented'
              error stop 1
           end select
           Predefined_Obs_Cotunneling  = Z
           
        elseif (N_FL == 2 )   then  !  This works only for N_SUN = 2
           do  ns = 1,2
              G1(1,1,ns)  = 1.d0 - GTT(I_f,I_f,ns)
              G1(1,2,ns)  = -G0T(J_c,I_f,ns)
              G1(1,3,ns)  = -G0T(J_f,I_f,ns)
              G1(2,1,ns)  = -GTT(I_f,I_c,ns)
              G1(2,2,ns)  = -G0T(J_c,I_c,ns)
              G1(2,3,ns)  = -G0T(J_f,I_c,ns)
              G1(3,1,ns)  = -GT0(I_f,J_f,ns)
              G1(3,2,ns)  = -G00(J_c,J_f,ns)
              G1(3,3,ns)  = 1.d0 - G00(J_f,J_f,ns)
           enddo
           Z =    1.*(-(G1(1,3,2)*G1(2,2,1)*G1(3,1,1)) + G1(1,3,2)*G1(2,1,1)*G1(3,2,1))    - &
                &  0.5*(G1(1,2,1)*G1(2,3,2)*G1(3,1,1) - G1(1,1,1)*G1(2,3,2)*G1(3,2,1))     + &
                &  0.5*(G1(1,3,2)*G1(2,1,2)*G1(3,2,1) - G1(1,1,2)*G1(2,3,2)*G1(3,2,1))     + &
                &  1.*(-(G1(1,3,1)*G1(2,2,2)*G1(3,1,2)) + G1(1,3,1)*G1(2,1,2)*G1(3,2,2))   + &
                &   0.5*(G1(1,3,1)*G1(2,1,1)*G1(3,2,2) - G1(1,1,1)*G1(2,3,1)*G1(3,2,2))    - &
                &  0.5*(G1(1,2,2)*G1(2,3,1)*G1(3,1,2) - G1(1,1,2)*G1(2,3,1)*G1(3,2,2))     - &
                &   0.5*(G1(1,2,2)*G1(2,3,1)*G1(3,1,1) - G1(1,2,2)*G1(2,1,1)*G1(3,3,1))    + &
                &  0.5*(G1(1,3,1)*G1(2,1,2)*G1(3,2,1) - G1(1,2,1)*G1(2,1,2)*G1(3,3,1))     + &
                &  0.25*(-(G1(1,3,1)*G1(2,2,1)*G1(3,1,1)) + G1(1,2,1)*G1(2,3,1)*G1(3,1,1)  + &
                &     G1(1,3,1)*G1(2,1,1)*G1(3,2,1) - G1(1,1,1)*G1(2,3,1)*G1(3,2,1)        - &
                &     G1(1,2,1)*G1(2,1,1)*G1(3,3,1) + G1(1,1,1)*G1(2,2,1)*G1(3,3,1))       - &
                &  0.25*(-(G1(1,1,2)*G1(2,3,1)*G1(3,2,1)) + G1(1,1,2)*G1(2,2,1)*G1(3,3,1)) + &
                &  0.25*(-(G1(1,3,1)*G1(2,2,2)*G1(3,1,1)) + G1(1,1,1)*G1(2,2,2)*G1(3,3,1)) - &
                &  0.25*(-(G1(1,2,2)*G1(2,1,2)*G1(3,3,1)) + G1(1,1,2)*G1(2,2,2)*G1(3,3,1)) + &
                &  0.5*(G1(1,3,2)*G1(2,1,1)*G1(3,2,2) - G1(1,2,2)*G1(2,1,1)*G1(3,3,2))     - &
                &  0.5*(G1(1,2,1)*G1(2,3,2)*G1(3,1,2) - G1(1,2,1)*G1(2,1,2)*G1(3,3,2))     - &
                &  0.25*(-(G1(1,2,1)*G1(2,1,1)*G1(3,3,2)) + G1(1,1,1)*G1(2,2,1)*G1(3,3,2)) + &
                &   0.25*(-(G1(1,3,2)*G1(2,2,1)*G1(3,1,2)) + G1(1,1,2)*G1(2,2,1)*G1(3,3,2))- &
                &  0.25*(-(G1(1,1,1)*G1(2,3,2)*G1(3,2,2)) + G1(1,1,1)*G1(2,2,2)*G1(3,3,2)) + &
                &  0.25*(-(G1(1,3,2)*G1(2,2,2)*G1(3,1,2)) + G1(1,2,2)*G1(2,3,2)*G1(3,1,2)  + &
                &     G1(1,3,2)*G1(2,1,2)*G1(3,2,2) - G1(1,1,2)*G1(2,3,2)*G1(3,2,2)        - &
                &     G1(1,2,2)*G1(2,1,2)*G1(3,3,2) + G1(1,1,2)*G1(2,2,2)*G1(3,3,2))
           Predefined_Obs_Cotunneling  = Z
        endif
 
      end function Predefined_Obs_Cotunneling
