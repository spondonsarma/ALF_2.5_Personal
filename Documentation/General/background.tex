\section{Theory part}


\subsection{Definition of the physical Hamiltonian and its implementation}

The physical Hamiltonians that we can simulate have the general form:

%% Fakhers notation
% \begin{equation}
% \label{eqn_general_ham1}
% \mathcal{H}
% =\sum\limits_{s=1}^{N_{fl}}\sum\limits_{x,y}
% c^{\dagger}_{x s}M_{xy}c^{\phantom\dagger}_{ys}
% -\sum\limits_{k=1}^{M}U_{k}\left[
% \sum\limits_{s=1}^{N_{fl}}\sum\limits_{x,y}
% \left( 
% c^{\dagger}_{xs}T^{(k)}_{xy}c^{\phantom\dagger}_{ys}-\alpha_{k}
% \right)
% \right]^{2}\;.
% \end{equation}
\begin{equation}
\label{eqn_general_ham2}
\mathcal{H}
=\sum\limits_{s=1}^{N_{fl}}\sum\limits_{x,y}
c^{\dagger}_{xs}T_{xy}c^{\phantom\dagger}_{ys}
-\sum\limits_{k=1}^{M}U_{k}\left[
\sum\limits_{s=1}^{N_{fl}}\sum\limits_{x,y}
\left( 
c^{\dagger}_{xs}V^{(k)}_{xy}c^{\phantom\dagger}_{y s}-\alpha_{k}
\right)
\right]^{2}\;.
\end{equation}
Note, that  we introduced \textit{two} different labels to address spin degrees of freedom:
\begin{itemize}
\item The number of spin flavours is set by $N_{fl}$. 
\item The number $N_{sun}$ also labels spin states and specifially sets the symmetry group of the fermions, namely 
the dimension of the special unitary group $SU(N_{sun})$.
\end{itemize}
And the following labels specify the lattice sites:
\begin{itemize}
\item 
The indices $x,y$ are multi-indices that label degrees of freedom, containing lattice sites and spin states: $x=(i,\sigma)$, 
where $i=1,\cdots N_{sites}$ and $\sigma=1,\cdots N_{sun}$, so
\begin{equation}
\sum\limits_{x,y}\equiv
\sum\limits_{i=1,j=1}^{N_{sites}}\sum\limits_{\sigma=1,\sigma^{\prime}=1}^{N_{sun}}\;.
\end{equation}

\item The number of correlated sites which is a subset of all sites, is labelled by $M$  ($M\leq N_{sites}$).

\item Let us further define  $N_{dim}=N_{sun} N_{sites}$ such that the matrices $\bm{T}$ and $\bm{V}^{(k)}$ are  of dimension $N_{dim}\times N_{dim}$ 

\item $N_{sites}$ is the total number of spacial vertices: $N_{sites}=N_{unit\;cell} N_{orbital}$, where $N_{unit\;cell}$ is the number of unit cells of the underlying Bravais lattice and
$N_{orbital}$ is the number of (spacial) orbitals per unit cell \mycomment{Check the definition of $N_{orbital}$ in the code.}

\end{itemize}


\subsection{Structure of the matrices ${\bf T}$ and ${\bf V}^{(k)}$ and their implementation}

In general, the matrices ${\bf T}$ and ${\bf V}^{(k)}$ are sparse matrices. 
This property is used to minimize computational cost and storage.
In the following, we discuss the implementation of the single-particle matrix representation ${\bf V}^{(k)}$ of the interaction operator. 
The same logic applies for the hopping matrix ${\bf T}$.

We denote a subset of $N_{eff}$ \mycomment{(in the code, $N_{eff}$ is called just $N$)} degrees of freedom  by the set  $[z_{1},\cdots  z_{N_{eff}}]$ and define it to contain only vertices for which an interaction term is defined:
\begin{equation}
V^{(k)}_{x y}\neq 0\quad \text{only if} \quad x,y \in [z_{1}^{(k)},\cdots  z_{N_{eff}^{(k)}}^{(k)}]\;.
\end{equation}
We define the projection matrices $\mathbf{P}^{(k)}_{V}$ of dimension $N_{eff}^{(k)}\times N_{dim}$:
\begin{equation}
(P_{V}^{(k)})_{i,z}=\delta_{z_{i}^{(k)},z}\;,
\end{equation}
where $i\in [1,\cdots N_{eff}^{(k)}]$ and $z\in [1,\cdots N_{dim}]$. The matrix operator $\bm{P}^{(k)}_{V}$ picks out the non-vanishing entries of $\bm{V}^{(k)}$, 
which are contained in the $(N_{eff}^{(k)}\times N_{eff}^{(k)})$ - dimensional matrix $\bm{O}_{V}^{(k)}$:
\begin{equation}
\bm{V}^{(k)}=\bm{P}^{(k) T}_{V} \bm{O}_{V}^{(k)}\bm{P}^{(k)}_{V}\;,
\end{equation}
and
\begin{equation}
V_{xy}^{(k)}=(P^{(k)}_{V})_{ix} \left[O_{V}^{(k)}\right]_{ij}(P_{V}^{(k)})_{jy}=\sum\limits_{i,j}^{N_{eff}^{(k)}} \delta_{z_{i}^{(k)},x}  \left[O_{V}^{(k)}\right]_{ij} \delta_{z_{j}^{(k)},y} \;.
\end{equation}
\mycomment{Comment that the P matrices have only one non-vanishing entry per column.}
To set the  interaction part, we therefore have to specify the following:
\begin{itemize}
\item the matrix elements $\left[O_{V}^{(k)}\right]_{ij}$
\item the set $[z_{1}^{(k)},\cdots  z_{N_{eff}^{(k)}}^{(k)}]$ 
\item the interaction strenghts $U_{k}$
\item the numbers  $\alpha_{k}$.
\end{itemize}

\mycomment{Be more specific here what really has to specified in the actual code.}
The same logic also applies to the implementation of the hopping interaction \mycomment{be more specific}.

\subsection{The Hubbard-Stratonovich decomposition}

\subsection{Implementation: the \texttt{Operator} variable}

In the code implementation, we define a structure called \texttt{Operator}. 
This structure variable \texttt{Operator} bundles several components that are needed to define and use an operator matrix in the program.
In Fortran a structure variable like this is called a derived type. 
The components it contains are: 
\begin{itemize}
\item the projector ${\bm P}_{V}$,
\item the matrix ${\bm O}_V$, 
\item the effective dimension $N_{eff}$,
\item and a couple of auxiliary matrices and scalars.
\end{itemize}
In general, we will not only have one structure variable \texttt{Operator}, but a whole  array of these structures.

 

\begin{table}[h]
   \begin{tabular}{l l}
    Name of variable in the code & Description \\\hline
    \texttt{Op\_V\%N}            & effective dimension $N_{eff}$\\
    \texttt{Op\_V\%O}            &  matrix  $\mathbf{O}_{V}$\\
    \texttt{Op\_V\%U}            &  matrix containing the eigenvectors of $\mathbf{O}_{V}$  \\
    \texttt{Op\_V\%E}            &  eigenvalues of $\mathbf{O}_{V}$ \\
    \texttt{Op\_V\%P}            &  projection matrix $\mathbf{P}_{V}$ \\
    \texttt{Op\_V\%N\_non\_zero} &  number of non-vanishing eigenvalues of $\mathbf{O}_{V}$ \\
    \texttt{Op\_V\%g}            &  coupling strength in Hubbard-Stratonovich transformation \\  
    \texttt{Op\_V\%alpha}        &   constant, to set particle-hole symmetry \mycomment{correct?} 
   \end{tabular}
   \caption{Components of the \texttt{Operator} structure variable \texttt{Op\_V}.
   \label{tab:definitions}}
\end{table}