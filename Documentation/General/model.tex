
% !TEX root = Doc.tex
\section{Definition of the model Hamiltonian}

%\mycomment{Notation: Hats for second quantized operators, bold for matrices. \\
%  Structure:  \\ 1) We first want to define the model.  \\ 
 %                     2)  implementation of the QMC.  \\ 
 %                  3) Data structure  \\ 
%                   4) Practical implementation and some  simple test cases. }

 
The class of solvable models includes  Hamiltonians $\mathcal{H}$ having the following general form:
${\mathcal{H}=\mathcal{H}_{T}+\mathcal{H}_{V}} +  \mathcal{H}_{I} +   \mathcal{H}_{0,I}  $, where
\begin{eqnarray}
\label{eqn_general_ham2}
\mathcal{H}_{T}
&=&
\sum\limits_{k=1}^{M_T}
\sum\limits_{s=1}^{N_{fl}}
\sum\limits_{\sigma=1}^{N_{col}}
\sum\limits_{x,y}
c^{\dagger}_{x \sigma   s}T_{xy}^{(k s)} c^{\phantom\dagger}_{y \sigma s}  \equiv  \sum\limits_{k=1}^{M_T} \hat{T}^{(k)}\\
\mathcal{H}_{V}
&=&
-
\sum\limits_{k=1}^{M_V}U_{k}
\left\{
\sum\limits_{s=1}^{N_{fl}}
\sum\limits_{\sigma=1}^{N_{col}}
\left[
\left(
\sum\limits_{x,y}
c^{\dagger}_{x \sigma s}V_{xy}^{(k s)}c^{\phantom\dagger}_{y \sigma s}
\right)
-\alpha_{k s} 
\right]
\right\}^{2}  \equiv   -
\sum\limits_{k=1}^{M_V}U_{k}   \left(\hat{V}{(k)} \right)^2\\ 
\mathcal{H}_{I}  & = &
\sum\limits_{k=1}^{M_I} \hat{Z}_{k} 
\left\{
\sum\limits_{s=1}^{N_{fl}}
\sum\limits_{\sigma=1}^{N_{col}}
\left[
\sum\limits_{x,y}
c^{\dagger}_{x \sigma s} I_{xy}^{(k s)}c^{\phantom\dagger}_{y \sigma s}
\right]
\right\} \equiv \sum\limits_{k=1}^{M_I} \hat{Z}_{k}    \hat{I}^{(k)} 
\;.
\end{eqnarray}
The indices have the following meaning:
\begin{itemize}
\item The number of fermion \textit{flavors} is set by $N_{fl}$.  After the Hubbard Stratonovitch transformation, the action will be block diagonal in the flavor index. 
\item The number of fermion \textit{colors} is set by $N_{col}$.    The Hamiltonian is invariant under  SU($N_{col}$)  rotations. Note that  in the code $ N_{col} \equiv N_{SUn} $. 
%\mycomment{ Does it set the symmetry group of the fermions, namely 
%the dimension of the special unitary group $SU(N_{sun})$?}
\item The indices $x,y$ label lattice sites where $x,y=1,\cdots, N_{dim}$. 
$N_{dim}$ is the total number of spacial vertices: $N_{dim}=N_{unit\;cell} N_{orbital}$, where $N_{unit\;cell}$ is the number of unit cells of the underlying Bravais lattice and $N_{orbital}$ is the number of (spacial) orbitals per unit cell \mycomment{Check the definition of $N_{orbital}$ in the code.} 
\item Therefore, the  matrices $\bm{T}^{(k s)}$, $\bm{V}^{(ks)}$  and $\bm{I}^{(ks)}$ are  of dimension $N_{dim}\times N_{dim}$
\item The number of interaction terms  is labelled by $M_V$   and $M_I$.   $M_T> 1 $ would allow for a checkerboard decomposition. 
\item $\hat{Z}_k$ is an Ising variable which couples to a general one-body term. 
\item  $\mathcal{H}_{0,I}$  gives the dynamics of the Ising variable. 
%\mycomment{Be more general here and speak of correlated blocks?}
\end{itemize}
Note that the matrices  $\bm{T}^{(ks)}$,  $\bm{V}^{(ks)}$ and  $\bm{I}^{(ks)}$ explicitly depend on the flavor index $s$ but not on the color index $\sigma$. 
The color index $\sigma$ only appears in  the  second quantized operators such that the Hamiltonian is manifestly SU($N_{col}$)    symmetric.  We also require
the matrices $\bm{T}^{(ks)}$,  $\bm{V}^{(ks)}$ and  $\bm{I}^{(ks)}$  to be  hermitian. 


\subsection{Formulation of the QMC}  
The formulation of the  Monte Carlo simulation is based on the following.
\begin{itemize}
\item  We will work in  a basis  where  $\hat{Z}_k$ is diagonal. 
\item  We will discretize the imaginary time propagation: $\beta = \Delta \tau L_{\text{Trotter}} $
\item  We will use  the   discrete Hubbard Stratonovitch transformation: 
\begin{equation}
\label{HS_squares}
        e^{\Delta \tau  \lambda  A^2 } =
        \sum_{ l = \pm 1, \pm 2}  \gamma(l)
e^{ \sqrt{\Delta \tau \lambda }
       \eta(l)  O }
                + {\cal O} (\Delta \tau ^4)
\end{equation}
where the fields $\eta$ and $\gamma$ take the values:
\begin{eqnarray}
 \gamma(\pm 1) = 1 + \sqrt{6}/3, \; \; \gamma(\pm 2) = 1 - \sqrt{6}/3
\nonumber \\
 \eta(\pm 1 ) = \pm \sqrt{2 \left(3 - \sqrt{6} \right)},  \; \;
 \eta(\pm 2 ) = \pm \sqrt{2 \left(3 + \sqrt{6} \right)}.
\nonumber
\end{eqnarray}
\item From the above it follows that   the Monte Carlo configuration space is given by: 
\begin{equation}
	C = \left\{   s_{i,\tau} ,  l_{j,\tau}  \text{ with }  i=1\cdots M_I,  j = 1\cdots M_V,  \tau=1,L_{Trotter}  \right\}
\end{equation}
Here $s_{i,\tau} = \pm 1$ and  $l_{j,\tau}  = \pm 2, \pm 1 $.
\end{itemize}

With the above, the partition function of the model can be written as follows.
\begin{eqnarray}
Z = \text {Tr}   e^{-\beta \mathcal{H} } =   \text {Tr}  \left[ e^{-\Delta \tau \mathcal{H}_{0,I}}   \prod_{k=1}^{M_T}   e^{-\Delta \tau \hat{T}^{(k)}}  
    \prod_{k=1}^{M_V}   e^{  \Delta \tau  U_k \left(  \hat{V}^{(k)} \right)^2}   \prod_{k=1}^{M_I}   e^{  -\Delta \tau  \hat{\sigma}_{k}  \hat{I}^{(k)}} 
   \right]^{L_{\text{Trotter}}}  \nonumber \\
   \sum_{C} \left( \prod_{j=1}^{M_V} \prod_{\tau=1}^{L_{Trotter}} \gamma_{j,\tau} \right) e^{-S_{0,I} \left( \left\{ s_{i,\tau} \right\}  \right) } 
    \text {Tr}_{F}   \prod_{\tau=1}^{L_{Trotter}} \left[   \prod_{k=1}^{M_T}   e^{-\Delta \tau \hat{T}^{(k)}}  
    \prod_{k=1}^{M_V}   e^{  \sqrt{ \Delta \tau  U_k} \eta_{k,\tau} \hat{V}^{(k)} }   \prod_{k=1}^{M_I}   e^{  -\Delta \tau s_{k,\tau}  \hat{I}^{(k)}}  \right] \nonumber
\end{eqnarray}
In the above,  the trace $\text {Tr} $  runs over the Ising spins as well as over the fermionic degrees of freedom, and $ \text {Tr}_{F}  $ only over the  fermionc Fock space. 
$S_{0,I} \left( \left\{ s_{i,\tau} \right\}  \right)  $ is the action  corresponding to the Ising Hamiltonian,  and is only dependent on the Ising spins so that  it can be pulled out of the fermionic trace.
At this point,  and  since for a given configuration $C$  we are dealing with a free propagation, we can integrate out the fermions to obtain a determinant: 
\begin{eqnarray}
& &  \text {Tr}_{F}   \prod_{\tau=1}^{L_{Trotter}} \left[   \prod_{k=1}^{M_T}   e^{-\Delta \tau \hat{T}^{(k)}}  
    \prod_{k=1}^{M_V}   e^{  \sqrt{ \Delta \tau  U_k} \eta_{k,\tau} \hat{V}^{(k)} }   \prod_{k=1}^{M_I}   e^{  -\Delta \tau s_{k,\tau}  \hat{I}^{(k)}}  \right]  =   \\
&&    \prod_{s=1}^{N_{fl}} \left[  e^{- \sum_{k=1}^{M_V} \sum_{\tau = 1}^{L_{Trotter}}\sqrt{\Delta \tau U_k}  \alpha_{k,s} \eta_{k,\tau} } \det\left(  1 + 
     \prod_{\tau=1}^{L_{Trotter}}   \prod_{k=1}^{M_T}   e^{-\Delta \tau \bf{T}^{(ks)}}  
    \prod_{k=1}^{M_V}   e^{  \sqrt{ \Delta \tau  U_k} \eta_{k,\tau} \bf{V}^{(ks)} }   \prod_{k=1}^{M_I}   e^{  -\Delta \tau s_{k,\tau}  \bf{I}^{(ks)}}  
     \right) \right]^{N_{col}}  \nonumber 
\end{eqnarray}
This all in all, the partition function is given by:
\begin{eqnarray}
	Z = \text {Tr}   e^{-\beta \mathcal{H} }  =   \sum_{C}   e^{-S_{0,I} \left( \left\{ s_{i,\tau} \right\}  \right) }     \left[ \prod_{k=1}^{M_V} \prod_{\tau=1}^{L_{Trotter}} \gamma_{k,\tau} \right] 
	  e^{- N_{col }\sum_{s=1}^{N_{fl}} \sum_{k=1}^{M_V} \sum_{\tau = 1}^{L_{Trotter}}\sqrt{\Delta \tau U_k}  \alpha_{k,s} \eta_{k,\tau} }   \nonumber \\
	   \left[   \prod_{s=1}^{N_{fl}}\det\left(  1 + 
     \prod_{\tau=1}^{L_{Trotter}}   \prod_{k=1}^{M_T}   e^{-\Delta \tau \bf{T}^{(ks)}}  
    \prod_{k=1}^{M_V}   e^{  \sqrt{ \Delta \tau  U_k} \eta_{k,\tau} \bf{V}^{(ks)} }   \prod_{k=1}^{M_I}   e^{  -\Delta \tau s_{k,\tau}  \bf{I}^{(ks)}}  
     \right) \right]^{N_{col}} 
\end{eqnarray}

In the above, one notices that the weight factorizes in  the flavor index. The color index raises the determinant to the power $N_{col}$. This corresponds to  an explicit $SU(N_{col})$ symmetry   for each  configuration. This symmetry is manifest in the fact that the single particle  Green functions, again for a given  configuration C are color independent. 


The fundamental data structure in the code is the \texttt{Operator} type  which one uses to define the Hamiltonian.    

\subsection{The \texttt{Operator} type and specification of the model.}
\begin{table}[h]
   \begin{tabular}{l l}
    Name of variable in the code & Description \\\hline
    \texttt{Op\_V\%N}            &  effective dimension $N$ \\
    \texttt{Op\_V\%O}            &  matrix  $\mathbf{O}$  of dimension $N \times N$\\
    \texttt{Op\_V\%P}            &  projection matrix $\mathbf{P}_{V}$  encoded as a vector of dimension $N$.\\
     \texttt{Op\_V\%g}            &  coupling strength  \\  
    \texttt{Op\_V\%alpha}      &  constant \\
    \texttt{Op\_V\%type}        &  integer parameter to set the type of 
                                             HS transformation   (1 = Ising, 2 = Discrete HS, for perfect square)  \\ 
    \texttt{Op\_V\%U}            &  matrix containing the eigenvectors of $\mathbf{O}$  \\
    \texttt{Op\_V\%E}            &  eigenvalues of $\mathbf{O}_{V}$ \\
    \texttt{Op\_V\%N\_non\_zero} &  number of non-vanishing eigenvalues of $\mathbf{O}_{V}$ 
   \end{tabular}
   \caption{Components of the \texttt{Operator}  type \texttt{Op\_V}.
  %  One will have to specify $N$, $O$, $P$, $g$, $\alpha$ and the type.  The other variables will be automatically generated in the routine \texttt{Op\_Set}.  
    \label{Operator.type}}
\end{table}


In general, the matrices ${\bf T}^{(ks)}$, ${\bf V}^{(ks)}$  and   ${\bf I}^{(ks)}$are sparse Hermitian matrices.   
  ${\bf V}$ has dimension  $N_{dim} \times N_{dim} $.  Let us  denote  with  $ \left\{z_{1},\cdots,  z_{N}  \right\}$  a subset  of $N$ indices,  
for which
\begin{equation}
V_{x,y}  =
\left\{\begin{matrix}  V_{x,y}  &  \text{ if }   x,  y  \in \left\{ z_1, \cdots z_N \right\}\\ 
                                  0         &  \text{ otherwise } 
      \end{matrix}\right.
\end{equation}
 We define the $N \times N_{dim}$ matrices $\mathbf{P}$  as
\begin{equation}
\bm{P}_{i,x}=\delta_{z_{i},x}\;,
\end{equation}
where $i \in [1,\cdots, N ]$ and $ x  \in [1,\cdots, N_{dim}]$. The matrix  $\bm{P}$ picks out the non-vanishing entries of $\bm{V}$, 
which are contained in the rank-$N$  matrix $\bm{O}$.  Thereby: 
\begin{equation}
\bm{V} =\bm{P}^{T} \bm{O} \bm{P}\;,
\end{equation}
such that:
\begin{equation}
\bm{V}_{x,y} = \sum\limits_{i,j}^{N}  \bm{P}_{i,x}  \bm{O}_{i,j} \bm{P}_{j,y}=\sum\limits_{i,j}^{N} \delta_{z_{i},x}  \bm{O}_{ij} \delta_{z_{j},y} \;.
\end{equation}
Since  the  $\bm{P}$ matrices have only one non-vanishing entry per column,  they can be stored as a vector:
\begin{equation}
     \vec{P}_i = z_i.
\end{equation}  
There are  many useful  identities which emerge from this  structure. For example: 
\begin{equation}
	e^{\bm{V}} =  e^{\bm{P}^{T} \bm{O} \bm{P}}   = \sum_{n=0}^{\infty}  \frac{\left( \bm{P}^{T} \bm{O} \bm{P} \right)^n}{n!} =  \bm{P}^{T} e^{ \bm{O} } \bm{P}
\end{equation}
since 
\begin{equation}
	 \bm{P} \bm{P}^{T}= 1_{N\times N}.
\end{equation}

In the code, we define a structure called \texttt{Operator} to capture the above. 
This type \texttt{Operator} bundles several components that are needed to define and use an operator matrix in the program.  
The components of the operator $\bm{V} $ are listed in  the table \ref{Operator.type}.   $ \texttt{Op\_V} $  describes the operator:
\begin{equation}
             \left[ \left( \sum_{x,y} \hat{c}^{\dagger}_x \bm{V}_{x,y} \hat{c}^{\phantom{\dagger}}_{y}  \right) - \alpha \right]  
\end{equation}
where $ \bm{V} = \bm{P}^{T} \bm{O} \bm{P}$.  In general, we will not only have one structure variable \texttt{Operator}, but a whole  array of these structures, which defines the very Hamiltonian. 

In the code, there is one array of operators which defines the hopping $\pmb{T}^{(k,s)} $:  \texttt{Op\_T(M$_T$,N$_{fl}$)} .  In this case $\bm{V}$ corresponds to $\bm{T}^{(k,s)}$ and $g=-\Delta \tau$, 
and $\alpha = 0$.  The type variable is irrelevant. 

  There is another array   which defines the full interaction,  Ising as well as perfect square terms. For this  we define  the array \texttt{Op\_V(M$_V$+M$_I$,N$_{fl}$) }). In this context the variable \texttt{Op\_V\%type} specifies the interaction: Ising or  a perfect square.  If the interaction is of Ising type, then  $\bm{V}  = \bm{I}^{(k,s)} $, $\alpha = 0$ and $g = -\Delta \tau$.  
  If the interaction is a perfect square type, then  $\bm{V}  = \bm{V}^{(k,s)} $, $\alpha = \alpha_{k,s}$ and $g = \sqrt{\Delta \tau  U_k}$.  

%The variable $\texttt{Op\_V\%type}  $  in the operator structure  is required to specify  the following. If the operator  correspond to an interaction part of the Hamiltonian  then for 
%$\texttt{Op\_V\%type} =1 $   the operator referes to an Ising  operator $ \bm{I}^{k,s}$ and for  $\texttt{Op\_V\%type} =2 $  to $\bm{V}^{ks} $
%\begin{itemize}
%\item the projector ${\bm P}$, encoded as the vector $\vec{P}$,
%\item the matrix ${\bm O}$ of dimension $N \times N$  
%\item the effective dimension $N$,
%\item and a couple of auxiliary matrices and scalars.
%\end{itemize}
%The precise definition of the Operator type reads:




\subsection{The Lattice}

We have a lattice module  which  generate  a two dimensional Bravais lattice.  The user has to specify unit vectors $\vec{a}_1$ and $\vec{a}_2$ as well as   the size of the  lattice. The size is  characterized by  two vectors $\vec{L}_1$ and $\vec{L}_2$   and  the lattice is placed on a torus: 
\begin{equation}
	\hat{c}_{\vec{i} + \vec{L}_1 }  = \hat{c}_{\vec{i} + \vec{L}_2 }  = \hat{c}_{\vec{i}}
\end{equation}
The call to 
\texttt{ Call Make\_Lattice( L1, L2, a1,  a2, Latt )} will generate the lattice   \texttt{Latt} of type \texttt{Lattice}.   Note that  the structure of the unit cell has to be provided by the user. 
 
\mycomment{We need to add a table for the lattice type.}


\subsection{The Observables}

We have three types of observables. 
\begin{itemize}
\item Scalar observables such as the energy
\item Equal time correlation functions.  Let $\hat{O}_{\vec{i},\alpha} $ be a local observable,  with $\vec{i}$ labelling the unit cell and $\alpha$ labelling the orbital or bone emanating 
from the unit cell.   The program will compute: 
\begin{equation}
	S_{\alpha,\beta}(\vec{k}) = \frac{1}{N_{unit \;  cells}} \sum_{\vec{i},\vec{j}} e^{i \vec{k}\cdot (\vec{i} -  \vec{j} ) } \left( \langle \hat{O}_{\vec{i},\alpha}  \hat{O}_{\vec{j},\alpha} \rangle  - 
	  \langle \hat{O}_{\vec{i},\beta} \rangle \langle   \hat{O}_{\vec{i},\beta}  \rangle \right) 
\end{equation}
\item  Time displaced correlation functions. This has a very similar structure than above but now with an additional time index.
\begin{equation}
	S_{\alpha,\beta}(\vec{k},\tau) = \frac{1}{N_{unit \;  cells}} \sum_{\vec{i},\vec{j}} e^{i \vec{k}\cdot (\vec{i} -  \vec{j} ) } \left( \langle \hat{O}_{\vec{i},\alpha} (\tau) \hat{O}_{\vec{j},\alpha} \rangle  - 
	  \langle \hat{O}_{\vec{i},\beta} \rangle \langle   \hat{O}_{\vec{i},\beta}  \rangle \right) 
\end{equation}
\end{itemize}

\mycomment{We have to add some  more details.}

%To set the  interaction part, we therefore have to specify the following:
%\begin{itemize}
%\item the matrix elements $\left[O_{V}^{(k)}\right]_{ij}$
%\item the set $[z_{1}^{(k)},\cdots  z_{N_{eff}^{(k)}}^{(k)}]$ 
%\item the interaction strenghts $U_{k}$
%\item the numbers  $\alpha_{k}$.
%\end{itemize}
%\mycomment{Be more specific here what really has to specified in the actual code.}%
%The same logic also applies to the implementation of the hopping interaction \mycomment{be more specific}.






%\begin{itemize}
%\item in the coupling $g$ in the \texttt{Operator} structure (see Sec.~\ref{}).
%\item as normalization constant in the definition of observables (see Sec.~\ref{})
%\item as exponent in the calculation of the phase factor and the Monte Carlo update ratio.
%\end{itemize}
%\subsection{Structure of the hopping matrix  ${\bf T}$ and the interaction matrices ${\bf V}^{(k)}$}


%\subsection{The Hubbard-Stratonovich decomposition} 
%Consider a single-particle (in other words bilinear) operator $O_{i}$.
%One obtains an approximation to the evolution operator by the following series expansion \cite{AssaadBook08}
%\begin{equation}
%\label{eqn_2_HS}
%e^{-\Delta\tau O^{2}_{i} } = \sum\limits_{s=\pm1,\pm2} \gamma(s) e^{i \sqrt{\Delta\tau}\eta(s)O_{i}} + \mathcal{O}(\Delta\tau^{4})\;,
%\end{equation}
%with 
%
%\begin{eqnarray}
%\gamma(\pm 1) = (1+\sqrt{6}/3)/4\;,\;\gamma(\pm 2) = (1-\sqrt{6}/3)/4\;,\nonumber\\
%\eta(\pm 1) =\pm \sqrt{2(3-\sqrt{6})}\;,\;\eta(\pm 2) =\pm \sqrt{2(3+\sqrt{6})}\;.
%\end{eqnarray}
%
%Eq.~(\ref{eqn_2_HS}) can be easily proven by expanding its right hand side  to eighth order in $O_{i}$. 
%The transformation introduces therefore two Ising fields $s$ per lattice site $i$, taking the values $\pm 1$ and $\pm 2$.
%\mycomment{same label as the flavor index}
