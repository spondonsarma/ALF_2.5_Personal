% Copyright (c) 2016 The ALF project.
% This is a part of the ALF project documentation.
% The ALF project documentation by the ALF contributors is licensed
% under a Creative Commons Attribution-ShareAlike 4.0 International License.
% For the licensing details of the documentation see license.CCBYSA.

% !TEX root = Doc.tex
%------------------------------------------------------------
\section{Updating schemes}\label{sec:updating}
%------------------------------------------------------------
%
The program allows for different types of updating schemes.    Given a configuration $C$ we propose a new one, $C'$, with probability $T_0(C \rightarrow C')$  and accept it according to 
\begin{equation}
	P(C \rightarrow C') =  \text{min}  \left( 1, \frac{T_0(C' \rightarrow C) W(C')}{T_0(C \rightarrow C') W(C)} \right)
\end{equation}
so as to guarantee the stationarity condition.  Here, $ W(C) = \left| \Re \left[ e^{-S(C)} \right] \right|   $.

\begin{table}[h]
   \begin{tabular}{@{} l l l @{}}\toprule
        Variable  &  Type                  &  Description   \\
         \\\midrule
       \texttt{Propose\_S0}   &    Logical       &  If true, proposes local moves according to the probability $e^{-S_0}$ \\
       \texttt{Global\_moves} & Logical       & If true, allows for global moves. \\
        \texttt{N\_Global }       & Integer        &   Number of global moves per sweep of single spin flips.
         \\\bottomrule
   \end{tabular}
   \caption{   Variables  required to control the updating scheme    \label{table:Updating_schemes}}
\end{table}
\subsection{The Default: sequential  single spin flips}
 The default updating scheme is a  sequential single  spin flip algorithm.   Consider   the Ising spin $s_{i,\tau}$, we will flip it with probability one such that for  this local move  the  proposal matrix is symmetric.  If we are considering the Hubbard-Stratonovich field $l_{i,\tau}$  we will propose with probability $1/3$ one  of the other three  possible fields.   Again, for this local move, the proposal matrix is symmetric.  Hence in both cases we will accept or reject the move according to 
 \begin{equation}
 	P(C \rightarrow C') =  \text{min}  \left( 1, \frac{ W(C')}{W(C)} \right)
 \end{equation}
 In is worth noting that this type of sequential spin flip updating does not satisfy detailed balance but the more fundamental stationarity condition. 
 \subsection{Sampling of $e^{-S_0}$}
  Consider an Ising spin at space time $i,\tau$ and the configuration $C$. Flipping this spin will generate the configuration $C'$ and we will propose the move according to 
  \begin{equation}
 T_0(C \rightarrow C')  =  \frac{e^{-S_0(C')}}{ e^{-S_0(C')} + e^{-S_0(C)} }   = 1 - \frac{1}{1 +  e^{-S_0(C')} /e^{-S_0(C)}}
  \end{equation}
 Note that the function $\texttt{S0}$ in the  \texttt{Hamitonian\_example.f90}  module  computes precisely the ratio $e^{-S_0(C')} /e^{-S_0(C)} $ so that  $T_0(C \rightarrow C') $ does not require any further programming. 
 Thereby one will accept  the proposed move with the probability: 
 \begin{equation}
 P(C \rightarrow C') =  \text{min}  \left( 1,  \frac{e^{-S_0(C)}   W(C')}{ e^{-S_0(C)'} W(C)} \right).
 \end{equation}
 With Eq.~\ref{eqn:partition_2}  one sees that the bare action $S_0(C)$  determining the  dynamics of the Ising spin  in the absence of coupling to the fermions  does not enter the Metropolis acceptance rejection step.  This sampling scheme is used  if the logical variable \texttt{Propose\_S0}   is switched on. 
 \subsection{Global updates}
The code equally allows for global updates.  The user will have to provide two other functions in the module \texttt{Hamiltonian\_Examples.f90}.   

The subroutine  \texttt{Global\_move(T0\_Proposal\_ratio,nsigma\_old)}  proposes  a global move. \\
\texttt{nsigma\_old(M\_V+ M\_I, Ltrot)} is a two dimensional  array containing  the full  configuration $C$.  On output, the new configuration, C',-- determined by the user -- is to be stored in the 
array  \texttt{nsigma(M\_V+ M\_I, Ltrot)}.    \texttt{nsigma(M\_V+ M\_I, Ltrot)} is a global variable declared in the module, \texttt{Hamiltonian}.  Equally, on output, the variable 
\texttt{T0\_Proposal\_ratio} contains the proposal ratio 
\begin{equation}
	 \frac{T_0(C' \rightarrow C)}{T_0(C \rightarrow C') }  
\end{equation}
Since we allow for a stochastic  generation of  the global move, it may very well be that no change is proposed. In this case, \texttt{T0\_Proposal\_ratio}   takes the value 0 upon exit, and  
\texttt{nsigma=nsigma\_old}.   

To compute the acceptance rejection ratio,  the user  will equally have to provide the function \\
\texttt{Delta\_S0\_global(Nsigma\_old)} that computes the ratio $e^{-S_0(C')}/e^{-S_0(C)}$. Again the configuration $C'$ is   given by the array \texttt{nsigma(M\_V+ M\_I, Ltrot)}  which is 
a global variable declared in the module, \texttt{Hamiltonian}.

Note that global updates are expensive since they require a complete recalculation of the weight. We thereby  allow the user to set a variable \texttt{N\_Global} that allows to  determine how many global updates per sweeps will be carried out. 

 
 
